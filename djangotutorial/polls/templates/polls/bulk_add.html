{% extends "base.html" %}

{% block title %}Importar Transacciones ‚Äî App-Finanzas{% endblock %}

{% block content %}
<style>
    /* Bulk import specific styles matching neo-brutalist theme */
    .bulk-section {
        margin: 1.5rem 0;
        padding: 1rem;
        border: 4px solid var(--border);
        background: var(--panel);
    }
    .bulk-form-group {
        margin-bottom: 1rem;
    }
    .bulk-form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.4rem;
        color: var(--muted);
    }
    .bulk-form-group select,
    .bulk-form-group textarea,
    .bulk-form-group input {
        width: 100%;
        padding: 0.6rem;
        font-family: inherit;
        border: 3px solid var(--border);
        background: #fff;
        box-sizing: border-box;
    }
    .bulk-form-group textarea {
        min-height: 150px;
        font-size: 0.85rem;
    }
    .bulk-form-group small {
        display: block;
        margin-top: 0.3rem;
        color: var(--muted);
        opacity: 0.7;
    }
    .bulk-btn {
        padding: 0.7rem 1.2rem;
        font-weight: 800;
        border: 3px solid var(--border);
        background: var(--accent);
        color: #fff;
        cursor: pointer;
        font-family: inherit;
        margin-right: 0.5rem;
        display: inline-block;
        text-decoration: none;
    }
    .bulk-btn:hover {
        transform: translateY(-2px);
        box-shadow: 4px 4px 0 var(--border);
    }
    .bulk-btn-secondary {
        background: var(--panel);
        color: var(--muted);
    }
    .bulk-btn-success {
        background: #10b981;
    }
    .bulk-alert {
        padding: 0.8rem;
        margin: 1rem 0;
        border: 3px solid var(--border);
        border-left-width: 6px;
    }
    .bulk-alert-info {
        background: #dbeafe;
        border-left-color: #3b82f6;
    }
    .bulk-alert-warning {
        background: #fef3c7;
        border-left-color: #f59e0b;
    }
    .bulk-alert-danger {
        background: #fee2e2;
        border-left-color: #ef4444;
    }
    .bulk-alert-success {
        background: #d1fae5;
        border-left-color: #10b981;
    }
    .bulk-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        border: 3px solid var(--border);
    }
    .bulk-table thead {
        background: var(--muted);
        color: #fff;
    }
    .bulk-table th,
    .bulk-table td {
        padding: 0.6rem;
        border: 2px solid var(--border);
        text-align: left;
    }
    .bulk-table tbody tr:nth-child(even) {
        background: #f9fafb;
    }
    .bulk-table input[type="text"],
    .bulk-table input[type="checkbox"] {
        font-family: inherit;
    }
    .bulk-table input[type="text"] {
        padding: 0.4rem;
        border: 2px solid var(--border);
        width: 100%;
        box-sizing: border-box;
    }
    .bulk-row-duplicate {
        background-color: rgba(255, 193, 7, 0.15) !important;
    }
    .bulk-grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    @media (max-width: 768px) {
        .bulk-grid-2col {
            grid-template-columns: 1fr;
        }
    }
</style>

<h1>üìã Importar Transacciones</h1>
<p style="margin: 0.5rem 0 1.5rem 0; opacity: 0.8;">
    Copia y pega datos desde tu banco para importar m√∫ltiples transacciones a la vez.
</p>

<section class="bulk-section">
    <form id="bulkImportForm" method="post" action="{% url 'polls:bulk_parse' %}">
        {% csrf_token %}
        
        <div class="bulk-grid-2col">
            <div class="bulk-form-group">
                <label for="bank">Banco *</label>
                <select name="bank" id="bank" required>
                    <option value="">--- Selecciona un banco ---</option>
                    {% for code, name in banks.items %}
                    <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="bulk-form-group" id="currencyContainer" style="display: none;">
                <label for="currency">Moneda</label>
                <select name="currency" id="currency">
                    <option value="">--- Selecciona moneda ---</option>
                    <option value="UYU">UYU - Peso Uruguayo</option>
                    <option value="USD">USD - D√≥lar</option>
                </select>
            </div>
        </div>
        
        <div class="bulk-form-group">
            <label for="rawText">Datos de Transacciones *</label>
            <textarea name="raw_text" id="rawText" rows="10" 
                      placeholder="Pega aqu√≠ los datos copiados de tu banco (columnas separadas por tabulaci√≥n)..."
                      required></textarea>
            <small>Los datos deben estar separados por tabulaciones. Cada fila representa una transacci√≥n.</small>
        </div>
        
        <button type="button" class="bulk-btn" id="processBtn" onclick="processData()">
            Procesar Datos
        </button>
        <a href="{% url 'profile' %}" class="bulk-btn bulk-btn-secondary">
            Cancelar
        </a>
    </form>
</section>

<!-- Datalists for categories and payees -->
<datalist id="categoriesList">
    {% for category in user_categories %}
    <option value="{{ category }}">
    {% endfor %}
</datalist>

<datalist id="payeesList">
    {% for payee in user_payees %}
    <option value="{{ payee }}">
    {% endfor %}
</datalist>

<!-- Preview Section (hidden until data is processed) -->
<section id="previewSection" class="bulk-section" style="display: none; margin-top: 2rem;">
    <h2 style="margin: 0 0 1rem 0;">Vista Previa</h2>
    
    <!-- Errors/Warnings -->
    <div id="errorsContainer"></div>
    
    <!-- Summary -->
    <div class="bulk-alert bulk-alert-info" id="summaryAlert" style="display: none;">
        <strong id="summaryText"></strong>
    </div>
    
    <!-- Transactions Table -->
    <div id="tableContainer" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">Transacciones (<span id="transactionCount">0</span>)</h3>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                <span>Seleccionar todas</span>
            </label>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="bulk-table" id="previewTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" class="form-check-input"></th>
                        <th style="width: 100px;">Date</th>
                        <th>Description</th>
                        <th style="width: 100px;">Amount</th>
                        <th style="width: 60px;">Currency</th>
                        <th style="width: 150px;">Category</th>
                        <th style="width: 150px;">Payee</th>
                        <th style="width: 100px;">Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <button type="button" class="bulk-btn bulk-btn-success" id="confirmBtn" onclick="confirmTransactions()">
                ‚úì Agregar Seleccionadas
            </button>
            <button type="button" class="bulk-btn bulk-btn-secondary" onclick="resetForm()">
                Cancelar y Editar
            </button>
        </div>
    </div>
</section>

<script>
// Store parsed transactions
let parsedTransactions = [];

// Bank currency requirements (banks that require explicit currency selection)
const banksRequiringCurrency = {
    'itau_debito': true,
};

// Update currency visibility when bank changes
document.getElementById('bank').addEventListener('change', function() {
    const requiresCurrency = banksRequiringCurrency[this.value] || false;
    document.getElementById('currencyContainer').style.display = requiresCurrency ? 'block' : 'none';
    
    if (!requiresCurrency) {
        document.getElementById('currency').value = '';
    }
});

function processData() {
    const rawText = document.getElementById('rawText').value.trim();
    const bank = document.getElementById('bank').value.trim();
    const currency = document.getElementById('currency').value.trim();
    
    if (!rawText) {
        showError('Please paste some data first.');
        return;
    }
    
    if (!bank) {
        showError('Please select a bank.');
        return;
    }
    
    // Disable button and show loading
    const btn = document.getElementById('processBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    // Make API call
    const formData = new FormData();
    formData.append('raw_text', rawText);
    formData.append('bank', bank);
    if (currency) {
        formData.append('currency', currency);
    }
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "polls:bulk_parse" %}', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            handleParseSuccess(data);
        } else {
            showErrors(data.errors || ['Unknown error']);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showError('Error: ' + error.message);
    });
}

function handleParseSuccess(data) {
    parsedTransactions = data.transactions;
    
    // Clear previous state
    document.getElementById('errorsContainer').innerHTML = '';
    
    // Show summary
    const summary = `Processed ${data.total_parsed} rows. ${data.total_valid} valid transaction(s) ready to import.`;
    document.getElementById('summaryText').innerText = summary;
    document.getElementById('summaryAlert').style.display = 'block';
    
    // Show validation errors as warnings if any
    if (data.validation_errors && data.validation_errors.length > 0) {
        let warningHtml = '<div class="alert alert-warning"><strong>Validation Issues:</strong><ul>';
        data.validation_errors.forEach(err => {
            warningHtml += `<li><strong>Line ${err.line}:</strong> ${err.errors.join(', ')}</li>`;
        });
        warningHtml += '</ul></div>';
        document.getElementById('errorsContainer').innerHTML = warningHtml;
    }
    
    // Populate table
    populateTable(parsedTransactions);
    
    // Show preview section
    document.getElementById('previewSection').style.display = 'block';
    
    // Scroll to preview
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
}

function populateTable(transactions) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    transactions.forEach((txn, index) => {
        const isDuplicate = txn.is_duplicate || false;
        const statusIcon = isDuplicate ? '‚ö†Ô∏è' : '‚úì';
        const statusText = isDuplicate ? 'Ya existe' : 'Nueva';
        const statusStyle = isDuplicate ? 'color: orange; font-weight: bold;' : 'color: green;';
        const rowStyle = isDuplicate ? 'background-color: rgba(255, 193, 7, 0.1);' : '';
        
        const row = tbody.insertRow();
        if (isDuplicate) {
            row.className = 'bulk-row-duplicate';
        }
        row.innerHTML = `
            <td style="text-align: center;"><input type="checkbox" class="txn-checkbox" value="${index}" ${isDuplicate ? '' : 'checked'}></td>
            <td style="white-space: nowrap;">${txn.date || '-'}</td>
            <td>${txn.description || '-'}</td>
            <td class="text-right" style="white-space: nowrap;">${txn.amount || '-'}</td>
            <td>${txn.currency || '-'}</td>
            <td>
                <input type="text" 
                       class="form-control form-control-sm txn-category" 
                       data-index="${index}"
                       list="categoriesList"
                       placeholder="Category..."
                       style="min-width: 120px;">
            </td>
            <td>
                <input type="text" 
                       class="form-control form-control-sm txn-payee" 
                       data-index="${index}"
                       list="payeesList"
                       placeholder="Payee..."
                       style="min-width: 120px;">
            </td>
            <td style="${statusStyle}" title="${statusText}">
                <span style="font-size: 1.2rem;">${statusIcon}</span>
                <small style="white-space: nowrap;">${statusText}</small>
            </td>
        `;
    });
    
    document.getElementById('transactionCount').innerText = transactions.length;
    document.getElementById('tableContainer').style.display = 'block';
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.txn-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function confirmTransactions() {
    // Get selected transactions
    const checkboxes = document.querySelectorAll('.txn-checkbox:checked');
    const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (selectedIndices.length === 0) {
        showError('Please select at least one transaction.');
        return;
    }
    
    // Build transactions with category and payee
    const selectedTransactions = selectedIndices.map(i => {
        const txn = {...parsedTransactions[i]};
        
        // Get category and payee from inputs
        const categoryInput = document.querySelector(`.txn-category[data-index="${i}"]`);
        const payeeInput = document.querySelector(`.txn-payee[data-index="${i}"]`);
        
        if (categoryInput && categoryInput.value.trim()) {
            txn.category = categoryInput.value.trim();
        }
        
        if (payeeInput && payeeInput.value.trim()) {
            txn.payee = payeeInput.value.trim();
        }
        
        return txn;
    });
    
    // Disable button and show loading
    const btn = document.getElementById('confirmBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    // Make API call
    fetch('{% url "polls:bulk_confirm" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            transactions: selectedTransactions,
        }),
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            // Show success message
            const successHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('previewSection').insertAdjacentHTML('afterbegin', successHtml);
            
            // Reset form after 2 seconds
            setTimeout(() => {
                resetForm();
            }, 2000);
        } else {
            showErrors(data.errors || [data.message] || ['Unknown error']);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showError('Error: ' + error.message);
    });
}

function resetForm() {
    document.getElementById('bulkImportForm').reset();
    document.getElementById('previewSection').style.display = 'none';
    document.getElementById('currencyContainer').style.display = 'none';
    parsedTransactions = [];
}

function showError(message) {
    showErrors([message]);
}

function showErrors(errors) {
    let html = '<div class="alert alert-danger alert-dismissible fade show" role="alert">';
    html += '<strong>Error(s):</strong><ul>';
    errors.forEach(err => {
        if (typeof err === 'object') {
            html += `<li>${JSON.stringify(err)}</li>`;
        } else {
            html += `<li>${err}</li>`;
        }
    });
    html += '</ul>';
    html += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    html += '</div>';
    
    document.getElementById('errorsContainer').innerHTML = html;
}
</script>

{% endblock %}
