{% extends 'base.html' %}

{% block title %}Mi perfil â€” App-Finanzas{% endblock %}

{% block content %}

  <!-- Quick-add compact form -->
  <section id="quick-add" style="margin:1rem 0;padding:0.75rem;border:1px solid var(--accent);background:var(--panel);">
    <style>
      /* Compact grid for quick-add, keeps fields aligned and wraps neatly on mobile */
      #quick-add .qa-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
        gap:0.6rem;
        align-items:center;
      }
      #quick-add input{width:100%;box-sizing:border-box;padding:0.5rem 0.65rem}
      #quick-add input[type=number]{appearance:textfield;-moz-appearance:textfield}
      #quick-add input[type=number]::-webkit-outer-spin-button,
      #quick-add input[type=number]::-webkit-inner-spin-button{margin:0;-webkit-appearance:none}
      #quick-add .qa-grid button{grid-column:1/-1}
      @media(min-width:960px){
        #quick-add .qa-grid{grid-template-columns:repeat(4,1fr)}
      }
    </style>
    <form id="quick-add-form" action="{% url 'polls:quick_transaction' %}" method="post">
      {% csrf_token %}
      <div class="qa-grid">
        <input name="description" id="qa-description" class="qa-description" placeholder="DescripciÃ³n*" required>
        <input name="amount" id="qa-amount" class="qa-amount" type="number" step="0.01" placeholder="Ej: 123.45" required>
        <input name="date" id="qa-date" type="date" required>
        <input name="currency" id="qa-currency" class="qa-currency" list="qa-currencies" placeholder="EUR* / USD*" maxlength="3" required>
        <datalist id="qa-currencies">
          <option value="USD">
          <option value="EUR">
          <option value="UYU">
          <option value="ARS">
          <option value="BRL">
          <option value="GBP">
          <option value="CLP">
          <option value="MXN">
        </datalist>
        <!-- Category: text input with server-rendered suggestions -->
        <input name="category" id="qa-category" list="qa-categorys" placeholder="CategorÃ­a...">
        <datalist id="qa-categorys">
          {% for name in qa_categories %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Project: text input with server-rendered suggestions -->
        <input name="project" id="qa-project" list="qa-projects" placeholder="Proyecto...">
        <datalist id="qa-projects">
          {% for name in qa_projects %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Payee: text input with server-rendered suggestions -->
        <input name="payee" id="qa-payee" list="qa-payees" placeholder="Beneficiario...">
        <datalist id="qa-payees">
          {% for name in qa_payees %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Source: text input with server-rendered suggestions -->
        <input name="source" id="qa-source" list="qa-sources" placeholder="Origen...">
        <datalist id="qa-sources">
          {% for name in qa_sources %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>
        <button id="qa-submit" type="submit">AÃ±adir</button>
      </div>
    </form>
    <div id="qa-msg" aria-live="polite" style="margin-top:0.5rem;opacity:0;transition:opacity .2s">&nbsp;</div>
    
    <!-- Bulk import link -->
    <div style="margin-top:1rem;padding-top:0.75rem;border-top:1px dashed var(--accent);">
      <a href="{% url 'polls:bulk_add' %}" 
         style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:var(--accent);color:var(--bg);text-decoration:none;border-radius:4px;font-weight:500;transition:opacity .2s"
         onmouseover="this.style.opacity='0.8'" 
         onmouseout="this.style.opacity='1'">
        ðŸ“‹ Importar mÃºltiples transacciones
      </a>
      <span style="margin-left:0.5rem;color:var(--muted);font-size:0.9rem">
        Copiar y pegar desde tu banco
      </span>
    </div>
  </section>


  <!-- Ãšltimas transacciones (paginadas, 5 por pÃ¡gina) -->
  <section id="recent-transactions" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Ãšltimas transacciones</h2>
    {% if tx_page and tx_page.object_list %}
      <ul style="list-style:none;padding:0;margin:0">
        {% for t in tx_page %}
          <li style="display:flex;gap:.5rem;align-items:center;border-bottom:1px dashed var(--accent);padding:.4rem 0">
            <a href="{% url 'polls:manage_transaction_edit' t.pk %}?next={{ request.get_full_path|urlencode }}"
              title="Editar"
              aria-label="Editar transacciÃ³n"
              style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;color:var(--muted);text-decoration:none;font-size:14px;line-height:1">ðŸ”§</a>
            <span style="flex:2;min-width:160px">{{ t.description }}</span>
            <span style="width:120px;text-align:right">{{ t.amount }}</span>
            <span style="width:70px;text-transform:uppercase;text-align:center">{{ t.currency }}</span>
            <span style="width:130px;text-align:right">{{ t.date }}</span>
          </li>
        {% endfor %}
      </ul>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.5rem">
        <div>
          {% if tx_page.has_previous %}
            <a href="?page={{ tx_page.previous_page_number }}">Â« Anterior</a>
          {% endif %}
        </div>
        <div>
          {% if tx_page.has_next %}
            <a href="?page={{ tx_page.next_page_number }}">Siguiente Â»</a>
          {% endif %}
        </div>
      </div>
      <div style="text-align:center;margin-top:.25rem">
        {% for num in tx_page.paginator.page_range %}
          {% if num == tx_page.number %}
            <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
          {% else %}
            <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      <p style="margin:0">AÃºn no hay transacciones.</p>
    {% endif %}
  </section>

  <!-- Gastos por categorÃ­a (USD) con selector de mes -->
  <section id="category-expenses" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Gastos por categorÃ­a</h2>
    <div style="text-align:center;margin:.25rem 0 .5rem 0">
      <a href="?m={{ m_prev }}">Â« Mes anterior</a>
      <span style="margin:0 .75rem">Mes {{ selected_month_str }}</span>
      {% if m_current != selected_month_str %}
        <a href="?m={{ m_current }}">Mes actual Â»</a>
      {% endif %}
    </div>
    {% if exp_missing_rates and exp_missing_rates > 0 %}
      <div class="message" style="background:#fff4f4">Faltan {{ exp_missing_rates }} tasas de cambio para convertir algunas transacciones.</div>
    {% endif %}
    <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left;border-bottom:2px solid var(--border);padding:.25rem 0">CategorÃ­a</th>
          <th style="text-align:right;border-bottom:2px solid var(--border);padding:.25rem 0">Gasto (USD)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in cat_expenses %}
          <tr>
            <td style="padding:.3rem 0;border-bottom:1px dashed var(--border)">{{ row.name }}</td>
            <td style="padding:.3rem 0;text-align:right;border-bottom:1px dashed var(--border)">$ {{ row.total_usd }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="2" style="padding:.3rem 0">Sin gastos en este mes.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <script>
  (function(){
    console.log('qa-init')
    // helpers
    function qs(sel){return document.querySelector(sel)}
    function qsa(sel){return document.querySelectorAll(sel)}

    const form = qs('#quick-add-form')
    const msg = qs('#qa-msg')

    // set default date to today
    const dateInput = qs('#qa-date')
    if(dateInput && !dateInput.value){
      const d = new Date();
      dateInput.value = d.toISOString().slice(0,10)
    }

    // Select options are rendered server-side on page load; no client fetch needed.

    // Fallback visual dropdown when browser doesn't show datalist suggestions
    function attachSuggestUI(inputSel, datalistSel){
      const input = qs(inputSel)
      const dl = qs(datalistSel)
      if(!input || !dl) return

      // create container
      const box = document.createElement('div')
      box.style.position = 'absolute'
      // debug-friendly visible styles
      box.style.background = '#ffffff'
      box.style.border = '2px solid #ff2d6d'
      box.style.padding = '4px'
      box.style.display = 'none'
      box.style.zIndex = '2147483647'
      box.style.maxHeight = '220px'
      box.style.overflow = 'auto'
      box.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)'
      box.className = 'qa-suggest-box'
      // append as sibling to input to avoid global click/overlay issues
      const parent = input.parentElement || input.closest('form') || document.body
      // ensure parent is positioned so absolute box is relative to it
      const parentPos = window.getComputedStyle(parent).position
      if(!parentPos || parentPos === 'static') parent.style.position = 'relative'
      parent.insertBefore(box, input.nextSibling)

      function rebuild(){
        box.innerHTML = ''
        const opts = Array.from(dl.querySelectorAll('option')).map(o=>o.value)
        // log for debugging
        console.log('qa-datalist rebuild', inputSel, opts)
        opts.forEach(val=>{
          const it = document.createElement('div')
          it.textContent = val
          it.style.padding = '4px'
          it.style.cursor = 'pointer'
          // use pointerdown to avoid blur-before-click issues and dispatch input event after setting
          it.addEventListener('pointerdown', function(ev){
            input.value = val
            input.dispatchEvent(new Event('input', {bubbles:true}))
            hide()
          })
          box.appendChild(it)
        })
        // If the input is currently focused, show the box so new options are visible immediately
        try{
          if(document.activeElement === input && box.children.length){
            show()
          }
        }catch(e){/* ignore */}
      }

      function show(){
        console.log('qa-show', inputSel)
        const rect = input.getBoundingClientRect()
        // position relative to parent
        const pRect = parent.getBoundingClientRect()
        box.style.left = (rect.left - pRect.left) + 'px'
        box.style.top = (rect.bottom - pRect.top) + 'px'
        box.style.width = rect.width + 'px'
        rebuild()
        box.style.display = 'block'
      }
      function hide(){ console.log('qa-hide', inputSel); box.style.display = 'none' }

      input.addEventListener('focus', ()=>{
        // if there are options, show box
        if(dl.querySelectorAll('option').length) show()
      })
      input.addEventListener('input', ()=>{
        const q = input.value.toLowerCase()
        Array.from(box.children).forEach(child=>{
          child.style.display = child.textContent.toLowerCase().includes(q) ? 'block' : 'none'
        })
        if(box.children.length && box.style.display!=='block') show()
      })
      // hide when input loses focus (delay to allow pointerdown selection)
      input.addEventListener('focusout', ()=>{
        setTimeout(()=>{
          if(document.activeElement !== input && !box.contains(document.activeElement)) hide()
        }, 120)
      })
      // rebuild when datalist updates
      const obs = new MutationObserver(rebuild)
      obs.observe(dl, {childList:true})
      console.log('qa-attachSuggestUI', inputSel, datalistSel)
    }

    // attach suggest UI to inputs
    // old datalist-based fallback is no longer used; still keep attachSuggestUI safe
    // attachSuggestUI('#qa-category','#qa-categories')
    // attachSuggestUI('#qa-project','#qa-projects')
    // attachSuggestUI('#qa-payee','#qa-payees')
    // attachSuggestUI('#qa-source','#qa-sources')

    // Debug helper: show datalist options and input values
    function updateDebug(){
      try{
        const parts = []
        ;['category','project','payee','source'].forEach(name=>{
          const inp = qs('#qa-'+name)
          const dl = qs('#qa-'+name+'s')
          if(!inp) return
          const opts = dl ? Array.from(dl.options).map(o=>({v:o.value,t:o.value})) : []
          parts.push(name.toUpperCase()+": options:"+opts.length+" value:"+(inp.value||''))
          parts.push(JSON.stringify(opts))
        })
        const debugEl = qs('#qa-debug')
        if(!debugEl){
          // No debug container present; skip safely
          return
        }
        debugEl.textContent = parts.join('\n')
      }catch(e){ console.log('qa-debug err', e) }
    }

    // wire up text inputs to update debug on change
    ;['category','project','payee','source'].forEach(name=>{
      const inp = qs('#qa-'+name)
      if(!inp) return
      inp.addEventListener('input', updateDebug)
      inp.addEventListener('change', updateDebug)
    })

    // submit handler (AJAX) â€” uses fetch and expects JSON
    form.addEventListener('submit', async function(ev){
      try{
        if(!form) return
        if(ev && typeof ev.preventDefault === 'function'){
          ev.preventDefault()
        } else if (window.event && typeof window.event.preventDefault === 'function'){
          window.event.preventDefault()
        }

        const fd = new FormData(form)
        // client-side amount validation/normalization
        const amtRaw = (fd.get('amount')||'').toString().replace(',','.')
        const amtNum = Number(amtRaw)
        if(!Number.isFinite(amtNum)){
          showMsg('Importe invÃ¡lido. Ej: 123.45', true)
          return
        }
        fd.set('amount', amtNum.toFixed(2))
        // client-side currency normalization
        const cur = (fd.get('currency')||'').toUpperCase().trim()
        if(!/^[A-Z]{3}$/.test(cur)){
          showMsg('Moneda invÃ¡lida (3 letras).', true)
          return
        }
        fd.set('currency', cur)

      try{
        const res = await fetch(form.action, {method:'POST', body:fd, credentials: 'same-origin', headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}})
        const contentType = res.headers.get('content-type') || ''
        let json = null
        if(contentType.includes('application/json')){
          json = await res.json()
        } else {
          showMsg('Respuesta inesperada del servidor.', true)
          return
        }
        if(res.ok && json.success){
          // Show success briefly, then refresh so new data appears
          showMsg(json.message || 'AÃ±adido', false)
          setTimeout(()=>{ window.location.reload() }, 700)
        }else{
          const errs = (json && (json.errors || (json.message && [json.message]))) || ['Error']
          showMsg(errs.join(' / '), true)
        }
      }catch(err){
        console.error('quick-add submit error', err)
        showMsg('Error enviando. IntentÃ¡ de nuevo.', true)
      }
      }catch(err){
        console.error('quick-add handler error', err)
        showMsg('Error procesando formulario.', true)
      }
    })

    // initial debug update so panel shows server-rendered values
    updateDebug()

    function showMsg(text, isError){
      msg.textContent = text
      msg.style.opacity = '1'
      msg.style.color = isError ? '#dc2626' : 'var(--accent)'
      setTimeout(()=>{ msg.style.opacity = '0' }, 1000)
    }
  })()
  </script>
{% endblock %}
