{% extends "base.html" %}

{% block title %}Importar Transacciones ‚Äî App-Finanzas{% endblock %}

{% block content %}
<h1 class="text-2xl md:text-3xl font-extrabold mb-2">üìã Importar Transacciones</h1>
<p class="text-slate-600 mb-6">
    Copia y pega datos desde tu banco para importar m√∫ltiples transacciones a la vez.
</p>

<section class="my-6 p-3 md:p-4 border-3 border-accent bg-panel rounded shadow-brutal">
    <form id="bulkImportForm" method="post" action="{% url 'expenses:bulk_parse' %}">
        {% csrf_token %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="mb-4">
                <label for="bank" class="block font-bold mb-2 text-base">Banco *</label>
                <select name="bank" id="bank" required class="w-full px-3 py-3 border-3 border-border bg-white text-base rounded-sm focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
                    <option value="">--- Selecciona un banco ---</option>
                    {% for code, name in banks.items %}
                    <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4 hidden" id="currencyContainer">
                <label for="currency" class="block font-bold mb-2 text-base">Moneda</label>
                <select name="currency" id="currency" class="w-full px-3 py-3 border-3 border-border bg-white text-base rounded-sm focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
                    <option value="">--- Selecciona moneda ---</option>
                    <option value="UYU">UYU - Peso Uruguayo</option>
                    <option value="USD">USD - D√≥lar</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="source" class="block font-bold mb-2 text-base">Fuente *</label>
                <input type="text"
                       name="source"
                       id="source"
                       list="sourcesList"
                       placeholder="Ej: Scotia 1234, ITAU D√©bito..."
                       required
                       class="w-full px-3 py-3 border-3 border-border bg-white text-base rounded-sm focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
                <small class="block mt-1 text-sm text-slate-600">Selecciona una fuente existente o escribe una nueva. Esta fuente se aplicar√° a todas las transacciones.</small>
            </div>
        </div>

        <!-- Datalist for sources -->
        <datalist id="sourcesList">
            {% for source in user_sources %}
            <option value="{{ source }}">
            {% endfor %}
        </datalist>

        <div class="mb-4">
            <label for="rawText" class="block font-bold mb-2 text-base">Datos de Transacciones *</label>
            <textarea name="raw_text" id="rawText" rows="10"
                      placeholder="Pega aqu√≠ los datos copiados de tu banco (columnas separadas por tabulaci√≥n)..."
                      required
                      class="w-full px-3 py-3 border-3 border-border bg-white text-base rounded-sm focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 font-mono text-sm"></textarea>
            <small class="block mt-1 text-sm text-slate-600">Los datos deben estar separados por tabulaciones. Cada fila representa una transacci√≥n.</small>
        </div>

        <div class="flex flex-wrap gap-3">
            <button type="button"
                    class="bg-accent text-white px-4 py-3 border-0 rounded font-extrabold cursor-pointer text-base transition-all shadow-brutal hover:-translate-y-0.5 hover:shadow-brutal-lg min-h-[44px]"
                    id="processBtn"
                    onclick="processData()">
                Procesar Datos
            </button>
            <a href="{% url 'profile' %}"
               class="bg-slate-200 text-slate-700 px-4 py-3 border-2 border-slate-300 rounded font-bold cursor-pointer transition-all hover:bg-slate-300 min-h-[44px] inline-flex items-center no-underline">
                Cancelar
            </a>
        </div>
    </form>
</section>

<!-- Datalists for categories and payees -->
<datalist id="categoriesList">
    {% for category in user_categories %}
    <option value="{{ category }}">
    {% endfor %}
</datalist>

<datalist id="payeesList">
    {% for payee in user_payees %}
    <option value="{{ payee }}">
    {% endfor %}
</datalist>

<!-- Preview Section (hidden until data is processed) -->
<section id="previewSection" class="my-6 p-3 md:p-4 border-3 border-accent bg-panel rounded shadow-brutal hidden">
    <h2 class="text-xl md:text-2xl font-extrabold mb-4">Vista Previa</h2>

    <!-- Errors/Warnings -->
    <div id="errorsContainer"></div>

    <!-- Summary -->
    <div class="p-4 mb-4 bg-blue-100 border-l-4 border-blue-500 hidden" id="summaryAlert">
        <strong id="summaryText" class="text-slate-700"></strong>
    </div>

    <!-- Transactions Cards -->
    <div id="tableContainer" class="hidden">
        <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
            <h3 class="text-lg md:text-xl font-extrabold m-0">Transacciones (<span id="transactionCount">0</span>)</h3>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" class="w-5 h-5 border-2 border-border cursor-pointer">
                <span class="font-semibold">Seleccionar todas</span>
            </label>
        </div>

        <!-- Card list instead of table -->
        <div id="tableBody" class="flex flex-col gap-3 mb-4"></div>

        <div class="flex flex-wrap gap-3 mt-6">
            <button type="button"
                    class="bg-green-500 text-white px-4 py-3 border-0 rounded font-extrabold cursor-pointer text-base transition-all shadow-brutal hover:-translate-y-0.5 hover:shadow-brutal-lg min-h-[44px]"
                    id="confirmBtn"
                    onclick="confirmTransactions()">
                ‚úì Agregar Seleccionadas
            </button>
            <button type="button"
                    class="bg-slate-200 text-slate-700 px-4 py-3 border-2 border-slate-300 rounded font-bold cursor-pointer transition-all hover:bg-slate-300 min-h-[44px]"
                    onclick="resetForm()">
                Cancelar y Editar
            </button>
        </div>
    </div>
</section>

<script>
// Store parsed transactions
let parsedTransactions = [];

// Bank currency requirements (banks that require explicit currency selection)
const banksRequiringCurrency = {
    'itau_debito': true,
};

// Update currency visibility when bank changes
document.getElementById('bank').addEventListener('change', function() {
    const requiresCurrency = banksRequiringCurrency[this.value] || false;
    const currencyContainer = document.getElementById('currencyContainer');

    if (requiresCurrency) {
        currencyContainer.classList.remove('hidden');
    } else {
        currencyContainer.classList.add('hidden');
        document.getElementById('currency').value = '';
    }
});

function processData() {
    const rawText = document.getElementById('rawText').value.trim();
    const bank = document.getElementById('bank').value.trim();
    const currency = document.getElementById('currency').value.trim();
    const source = document.getElementById('source').value.trim();
    
    if (!rawText) {
        showError('Please paste some data first.');
        return;
    }
    
    if (!bank) {
        showError('Please select a bank.');
        return;
    }
    
    if (!source) {
        showError('Por favor ingresa una fuente.');
        return;
    }
    
    // Disable button and show loading
    const btn = document.getElementById('processBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    // Make API call
    const formData = new FormData();
    formData.append('raw_text', rawText);
    formData.append('bank', bank);
    if (currency) {
        formData.append('currency', currency);
    }
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "expenses:bulk_parse" %}', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            handleParseSuccess(data);
        } else {
            showErrors(data.errors || ['Unknown error']);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showError('Error: ' + error.message);
    });
}

function handleParseSuccess(data) {
    parsedTransactions = data.transactions;

    // Clear previous state
    document.getElementById('errorsContainer').innerHTML = '';

    // Show summary
    const summary = `Processed ${data.total_parsed} rows. ${data.total_valid} valid transaction(s) ready to import.`;
    document.getElementById('summaryText').innerText = summary;
    document.getElementById('summaryAlert').classList.remove('hidden');

    // Show validation errors as warnings if any
    if (data.validation_errors && data.validation_errors.length > 0) {
        let warningHtml = '<div class="p-4 mb-4 bg-yellow-100 border-l-4 border-yellow-500"><strong class="text-slate-700">Validation Issues:</strong><ul class="mt-2 ml-4 list-disc">';
        data.validation_errors.forEach(err => {
            warningHtml += `<li><strong>Line ${err.line}:</strong> ${err.errors.join(', ')}</li>`;
        });
        warningHtml += '</ul></div>';
        document.getElementById('errorsContainer').innerHTML = warningHtml;
    }

    // Populate cards
    populateTable(parsedTransactions);

    // Show preview section
    document.getElementById('previewSection').classList.remove('hidden');

    // Scroll to preview
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
}

function populateTable(transactions) {
    const container = document.getElementById('tableBody');
    container.innerHTML = '';

    transactions.forEach((txn, index) => {
        const isDuplicate = txn.is_duplicate || false;
        const statusIcon = isDuplicate ? '‚ö†Ô∏è' : '‚úì';
        const statusText = isDuplicate ? 'Ya existe' : 'Nueva';
        const statusClass = isDuplicate ? 'bg-yellow-100 border-yellow-300 text-yellow-700' : 'bg-green-100 border-green-300 text-green-700';
        const cardBgClass = isDuplicate ? 'bg-yellow-50' : 'bg-white';

        const cardHtml = `
            <div class="relative p-4 border-3 border-border ${cardBgClass} rounded-md shadow-brutal transition-all hover:-translate-y-1 hover:shadow-brutal-lg">
                <!-- Header: Checkbox, Date, Description, Amount, Status -->
                <div class="flex flex-wrap md:flex-nowrap items-start gap-3 mb-3 pb-3 border-b-2 border-slate-100">
                    <!-- Checkbox -->
                    <div class="shrink-0 flex items-center">
                        <input type="checkbox"
                               class="txn-checkbox w-5 h-5 border-2 border-border cursor-pointer"
                               value="${index}"
                               ${isDuplicate ? '' : 'checked'}>
                    </div>

                    <!-- Date -->
                    <div class="text-sm font-semibold text-slate-500 shrink-0 w-full md:w-auto order-1">
                        ${txn.date || '-'}
                    </div>

                    <!-- Amount on mobile right, desktop middle-right -->
                    <div class="font-extrabold text-lg whitespace-nowrap text-muted px-3 py-1 bg-slate-100 rounded shrink-0 ml-auto md:ml-0 order-2 md:order-3">
                        ${txn.currency || ''} ${txn.amount || '-'}
                    </div>

                    <!-- Description - full width on mobile, flex-1 on desktop -->
                    <div class="w-full md:flex-1 font-semibold text-base text-muted leading-snug break-words order-3 md:order-2">
                        ${txn.description || '-'}
                    </div>

                    <!-- Status badge -->
                    <div class="shrink-0 px-2 py-1 border-2 ${statusClass} rounded text-sm font-bold whitespace-nowrap order-4">
                        ${statusIcon} ${statusText}
                    </div>
                </div>

                <!-- Controls: Category and Payee in 2 columns -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">üìÅ Categor√≠a</label>
                        <input type="text"
                               class="txn-category w-full px-3 py-2 text-sm border-2 border-slate-300 bg-white text-muted rounded font-semibold transition-all cursor-text hover:border-slate-400 focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]"
                               data-index="${index}"
                               list="categoriesList"
                               placeholder="Categor√≠a...">
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">üë§ Beneficiario</label>
                        <input type="text"
                               class="txn-payee w-full px-3 py-2 text-sm border-2 border-slate-300 bg-white text-muted rounded font-semibold transition-all cursor-text hover:border-slate-400 focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]"
                               data-index="${index}"
                               list="payeesList"
                               placeholder="Beneficiario...">
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', cardHtml);
    });

    document.getElementById('transactionCount').innerText = transactions.length;
    document.getElementById('tableContainer').classList.remove('hidden');
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.txn-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function confirmTransactions() {
    // Get selected transactions
    const checkboxes = document.querySelectorAll('.txn-checkbox:checked');
    const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (selectedIndices.length === 0) {
        showError('Please select at least one transaction.');
        return;
    }
    
    // Get the source from the form
    const sourceInput = document.getElementById('source');
    const sourceName = sourceInput ? sourceInput.value.trim() : '';
    
    if (!sourceName) {
        showError('Por favor ingresa una fuente.');
        return;
    }
    
    // Build transactions with category, payee, and source
    const selectedTransactions = selectedIndices.map(i => {
        const txn = {...parsedTransactions[i]};
        
        // Set the user-selected source (same for all transactions)
        txn.source = sourceName;
        
        // Get category and payee from inputs
        const categoryInput = document.querySelector(`.txn-category[data-index="${i}"]`);
        const payeeInput = document.querySelector(`.txn-payee[data-index="${i}"]`);
        
        if (categoryInput && categoryInput.value.trim()) {
            txn.category = categoryInput.value.trim();
        }
        
        if (payeeInput && payeeInput.value.trim()) {
            txn.payee = payeeInput.value.trim();
        }
        
        return txn;
    });
    
    // Disable button and show loading
    const btn = document.getElementById('confirmBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    // Make API call
    fetch('{% url "expenses:bulk_confirm" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            transactions: selectedTransactions,
        }),
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            // Show success message
            const successHtml = `
                <div class="p-4 mb-4 bg-green-100 border-l-4 border-green-500">
                    <strong class="text-green-700">Success!</strong> <span class="text-green-700">${data.message}</span>
                </div>
            `;
            document.getElementById('previewSection').insertAdjacentHTML('afterbegin', successHtml);

            // Reset form after 2 seconds
            setTimeout(() => {
                resetForm();
            }, 2000);
        } else {
            showErrors(data.errors || [data.message] || ['Unknown error']);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showError('Error: ' + error.message);
    });
}

function resetForm() {
    document.getElementById('bulkImportForm').reset();
    document.getElementById('previewSection').classList.add('hidden');
    document.getElementById('currencyContainer').classList.add('hidden');
    parsedTransactions = [];
}

function showError(message) {
    showErrors([message]);
}

function showErrors(errors) {
    let html = '<div class="p-4 mb-4 bg-red-100 border-l-4 border-red-500">';
    html += '<strong class="text-red-700">Error(s):</strong><ul class="mt-2 ml-4 list-disc text-red-700">';
    errors.forEach(err => {
        if (typeof err === 'object') {
            html += `<li>${JSON.stringify(err)}</li>`;
        } else {
            html += `<li>${err}</li>`;
        }
    });
    html += '</ul></div>';

    document.getElementById('errorsContainer').innerHTML = html;
}
</script>

{% endblock %}
