{% extends 'base.html' %}
{% load static %}

{% block title %}Transacciones{% endblock %}

{% block content %}
<p><a href="{% url 'profile' %}" class="text-accent font-bold hover:underline">‚Üê Volver al perfil</a></p>
<h1 class="text-2xl md:text-3xl font-extrabold mb-4">Transacciones</h1>

<!-- Filters Section -->
<section class="my-4 p-3 md:p-4 border-3 border-accent bg-panel rounded shadow-brutal">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-lg md:text-xl font-extrabold m-0">Filtros</h2>
    <button type="button" id="toggle-filters" class="bg-accent text-white px-4 py-2 text-sm md:text-base border-0 rounded font-bold cursor-pointer transition-all shadow-[3px_3px_0_rgba(255,0,102,0.2)] hover:-translate-y-0.5 hover:shadow-[4px_4px_0_rgba(255,0,102,0.3)]">
      <span id="toggle-text">Mostrar filtros</span>
    </button>
  </div>
  <form method="get" id="filters-form">
    <div id="filters-grid" class="!hidden grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
      <div>
        <label class="block font-semibold mb-1 text-sm">Buscar</label>
        <input type="text" name="search" value="{{ current_filters.search }}" placeholder="Descripci√≥n..." class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Categor√≠a</label>
        <select name="category" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
          <option value="">Todas</option>
          <option value="__null__" {% if current_filters.category == '__null__' %}selected{% endif %}>‚ùå Sin categor√≠a</option>
          {% for cat in categories %}
            <option value="{{ cat.name }}" {% if current_filters.category == cat.name %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Origen</label>
        <select name="source" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
          <option value="">Todos</option>
          <option value="__null__" {% if current_filters.source == '__null__' %}selected{% endif %}>‚ùå Sin origen</option>
          {% for src in sources %}
            <option value="{{ src.name }}" {% if current_filters.source == src.name %}selected{% endif %}>{{ src.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Proyecto</label>
        <select name="project" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
          <option value="">Todos</option>
          <option value="__null__" {% if current_filters.project == '__null__' %}selected{% endif %}>‚ùå Sin proyecto</option>
          {% for proj in projects %}
            <option value="{{ proj.name }}" {% if current_filters.project == proj.name %}selected{% endif %}>{{ proj.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Beneficiario</label>
        <select name="payee" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
          <option value="">Todos</option>
          <option value="__null__" {% if current_filters.payee == '__null__' %}selected{% endif %}>‚ùå Sin beneficiario</option>
          {% for p in payees %}
            <option value="{{ p.name }}" {% if current_filters.payee == p.name %}selected{% endif %}>{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Moneda</label>
        <select name="currency" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
          <option value="">Todas</option>
          {% for curr in currencies %}
            <option value="{{ curr }}" {% if current_filters.currency == curr %}selected{% endif %}>{{ curr }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Mes (YYYY-MM)</label>
        <input type="text" name="month" value="{{ current_filters.month }}" placeholder="2024-12" pattern="\d{4}-\d{2}" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Desde</label>
        <input type="date" name="date_from" value="{{ current_filters.date_from }}" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
      </div>
      <div>
        <label class="block font-semibold mb-1 text-sm">Hasta</label>
        <input type="date" name="date_to" value="{{ current_filters.date_to }}" class="w-full px-3 py-2 border-2 border-slate-300 rounded focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
      </div>
      <div class="flex items-end gap-2 sm:col-span-2 lg:col-span-3">
        <button type="submit" class="flex-1 bg-accent text-white px-4 py-2 border-0 rounded font-bold cursor-pointer transition-all shadow-brutal hover:-translate-y-0.5 hover:shadow-brutal-lg min-h-[44px]">Filtrar</button>
        <a href="{% url 'expenses:manage_transactions' %}" class="flex-1 bg-slate-500 text-white px-4 py-2 no-underline rounded text-center font-bold transition-all shadow-brutal hover:-translate-y-0.5 hover:shadow-brutal-lg min-h-[44px] flex items-center justify-center">Limpiar</a>
      </div>
    </div>
  </form>
  {% if page_obj %}
    <p class="mt-3 mb-0 text-muted text-sm">Total: {{ page_obj.paginator.count }} transacciones</p>
  {% endif %}
</section>

<!-- Transactions List -->
<section class="my-4 p-3 md:p-4 border-3 border-accent bg-panel rounded shadow-brutal">
  <h2 class="mt-0 text-lg md:text-xl font-extrabold">Lista de Transacciones</h2>
  {% if page_obj and page_obj.object_list %}
    <p class="mt-0 mb-4 text-muted text-sm">Mostrando {{ page_obj.object_list|length }} de {{ page_obj.paginator.count }}.</p>

    <!-- Mobile-first: 1 column on mobile, 2 on tablet, 3 on desktop -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
      {% for tx in page_obj %}
        <form id="tx-{{ tx.id }}" action="" method="post" class="relative p-4 border-3 border-border bg-white rounded-md shadow-brutal transition-all hover:-translate-y-1 hover:shadow-brutal-lg">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_tx">
          <input type="hidden" name="tx_id" value="{{ tx.id }}">

          <!-- Header: ID, Date, Description, Amount - CRITICAL INFO ON MOBILE -->
          <div class="flex justify-between items-start gap-3 mb-3 pb-3 border-b-2 border-slate-100">
            <div class="flex-1 min-w-0">
              <!-- Date and ID - Mobile readable size -->
              <div class="text-sm md:text-xs font-semibold text-slate-500 mb-2">
                <span class="font-extrabold text-muted">#{{ tx.id }}</span>
                <span class="mx-1">‚Ä¢</span>
                <span>{{ tx.date }}</span>
              </div>
              <!-- Description - Mobile readable, NOT truncated on mobile -->
              <div class="font-semibold text-base md:text-sm text-muted leading-snug break-words">
                {{ tx.description }}
              </div>
            </div>
            <!-- Amount + Currency - Prominent on mobile -->
            <div class="font-extrabold text-lg md:text-base whitespace-nowrap text-muted px-3 py-1 bg-slate-100 rounded shrink-0">
              {{ tx.currency }}<br class="md:hidden">{{ tx.amount }}
            </div>
          </div>

          <!-- Save status indicator -->
          <div id="save-status-{{ tx.id }}" class="absolute top-3 right-3 text-xs px-2 py-1 rounded bg-white font-bold z-10">
            <span class="spinner htmx-indicator inline-block"></span>
            <span class="status-text"></span>
          </div>

          <!-- Fields: Category, Source, Project - Stack on mobile for readability -->
          <div class="grid grid-cols-1 gap-3 mb-3">
            <div class="flex flex-col gap-1">
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">üìÅ Categor√≠a</label>
              <select name="category_id"
                      hx-post="{% url 'expenses:manage_transactions' %}"
                      hx-include="[name='tx_id'],[name='action'],[name='source_id'],[name='project_id'],[name='comments']"
                      hx-trigger="change"
                      hx-target="#save-status-{{ tx.id }}"
                      hx-swap="innerHTML"
                      hx-indicator="#save-status-{{ tx.id }}"
                      class="w-full px-3 py-2 text-sm border-2 border-slate-300 bg-white text-muted rounded font-semibold transition-all cursor-pointer hover:border-slate-400 focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
                <option value="">-</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {% if tx.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">üí≥ Origen</label>
              <select name="source_id"
                      hx-post="{% url 'expenses:manage_transactions' %}"
                      hx-include="[name='tx_id'],[name='action'],[name='category_id'],[name='project_id'],[name='comments']"
                      hx-trigger="change"
                      hx-target="#save-status-{{ tx.id }}"
                      hx-swap="innerHTML"
                      hx-indicator="#save-status-{{ tx.id }}"
                      class="w-full px-3 py-2 text-sm border-2 border-slate-300 bg-white text-muted rounded font-semibold transition-all cursor-pointer hover:border-slate-400 focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
                <option value="">-</option>
                {% for src in sources %}
                  <option value="{{ src.id }}" {% if tx.source_id == src.id %}selected{% endif %}>{{ src.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="flex flex-col gap-1">
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">üéØ Proyecto</label>
              <select name="project_id"
                      hx-post="{% url 'expenses:manage_transactions' %}"
                      hx-include="[name='tx_id'],[name='action'],[name='category_id'],[name='source_id'],[name='comments']"
                      hx-trigger="change"
                      hx-target="#save-status-{{ tx.id }}"
                      hx-swap="innerHTML"
                      hx-indicator="#save-status-{{ tx.id }}"
                      class="w-full px-3 py-2 text-sm border-2 border-slate-300 bg-white text-muted rounded font-semibold transition-all cursor-pointer hover:border-slate-400 focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 min-h-[44px]">
                <option value="">-</option>
                {% for proj in projects %}
                  <option value="{{ proj.id }}" {% if tx.project_id == proj.id %}selected{% endif %}>{{ proj.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Footer: Comment + Delete -->
          <div class="flex flex-col gap-2 pt-3 border-t-2 border-slate-100">
            <div class="flex flex-col gap-1">
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">üí¨ Comentario</label>
              <textarea name="comments"
                        rows="1"
                        placeholder="A√±adir nota..."
                        hx-post="{% url 'expenses:manage_transactions' %}"
                        hx-include="[name='tx_id'],[name='action'],[name='category_id'],[name='source_id'],[name='project_id']"
                        hx-trigger="input changed delay:1s"
                        hx-target="#save-status-{{ tx.id }}"
                        hx-swap="innerHTML"
                        hx-indicator="#save-status-{{ tx.id }}"
                        class="w-full px-3 py-2 text-sm border-2 border-slate-300 bg-white text-muted resize-none rounded min-h-[44px] leading-snug transition-all hover:border-slate-400 focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20">{{ tx.comments }}</textarea>
            </div>
            <button type="button"
                    class="w-full px-3 py-2 text-lg leading-none whitespace-nowrap bg-red-600 text-white border-2 border-red-700 rounded min-h-[44px] transition-all shadow-[2px_2px_0_rgba(220,38,38,0.3)] cursor-pointer font-bold hover:-translate-y-0.5 hover:shadow-[3px_3px_0_rgba(220,38,38,0.4)] hover:bg-red-700"
                    hx-post="{% url 'expenses:manage_transactions' %}"
                    hx-vals='{"action": "delete_tx", "tx_id": "{{ tx.id }}"}'
                    hx-confirm="¬øEliminar?"
                    hx-target="#tx-{{ tx.id }}"
                    hx-swap="outerHTML swap:300ms">üóëÔ∏è Eliminar</button>
          </div>
        </form>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_previous or page_obj.has_next %}
      <div class="flex flex-col sm:flex-row justify-between items-center gap-3 mt-4 pt-3 border-t-2 border-border">
        <div>
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}{% if current_filters.category %}&category={{ current_filters.category }}{% endif %}{% if current_filters.source %}&source={{ current_filters.source }}{% endif %}{% if current_filters.project %}&project={{ current_filters.project }}{% endif %}{% if current_filters.payee %}&payee={{ current_filters.payee }}{% endif %}{% if current_filters.currency %}&currency={{ current_filters.currency }}{% endif %}{% if current_filters.month %}&month={{ current_filters.month }}{% endif %}{% if current_filters.date_from %}&date_from={{ current_filters.date_from }}{% endif %}{% if current_filters.date_to %}&date_to={{ current_filters.date_to }}{% endif %}" class="text-accent font-bold no-underline transition-all hover:-translate-y-0.5 inline-block min-h-[44px] flex items-center">¬´ Anterior</a>
          {% endif %}
        </div>
        <div class="font-semibold">
          P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </div>
        <div>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}{% if current_filters.category %}&category={{ current_filters.category }}{% endif %}{% if current_filters.source %}&source={{ current_filters.source }}{% endif %}{% if current_filters.project %}&project={{ current_filters.project }}{% endif %}{% if current_filters.payee %}&payee={{ current_filters.payee }}{% endif %}{% if current_filters.currency %}&currency={{ current_filters.currency }}{% endif %}{% if current_filters.month %}&month={{ current_filters.month }}{% endif %}{% if current_filters.date_from %}&date_from={{ current_filters.date_from }}{% endif %}{% if current_filters.date_to %}&date_to={{ current_filters.date_to }}{% endif %}" class="text-accent font-bold no-underline transition-all hover:-translate-y-0.5 inline-block min-h-[44px] flex items-center">Siguiente ¬ª</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% else %}
    <p class="m-0">No se encontraron transacciones.</p>
  {% endif %}
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.getElementById('toggle-filters');
  const toggleText = document.getElementById('toggle-text');
  const filtersGrid = document.getElementById('filters-grid');

  if (!toggleBtn || !toggleText || !filtersGrid) {
    console.error('Filter elements not found');
    return;
  }

  // Always start with filters hidden
  filtersGrid.style.display = 'none';
  toggleText.textContent = 'Mostrar filtros';

  toggleBtn.addEventListener('click', function() {
    if (filtersGrid.style.display === 'none') {
      filtersGrid.style.display = 'grid';
      toggleText.textContent = 'Ocultar filtros';
    } else {
      filtersGrid.style.display = 'none';
      toggleText.textContent = 'Mostrar filtros';
    }
  });
});
</script>

{% endblock %}
