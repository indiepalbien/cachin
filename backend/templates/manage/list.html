{% extends 'base.html' %}

{% block title %}List ‚Äî Manage{% endblock %}

{% block content %}
  <p><a href="{{ back_url|default:'javascript:history.back()' }}">‚Üê Volver</a></p>
  <h1>{{ model_verbose_name_plural|capfirst }}</h1>
  {% if header_note %}
  <p><em>{{ header_note }}</em></p>
  {% endif %}

  {% if email_config %}
  <div style="margin-top: 1rem; padding: 1rem; border: 2px solid #333; background: #f9f9f9;">
    <h3>Configurar Email de Reenv√≠o</h3>
    <p><small>Si reenv√≠as facturas desde tu email personal, config√∫ralo aqu√≠ para que podamos identificar tus mensajes.</small></p>

    <form method="post" action="{% url 'expenses:update_forwarding_email' %}">
      {% csrf_token %}
      <label for="forwarding_email" style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Tu email personal:</label>
      <input
        type="email"
        id="forwarding_email"
        name="forwarding_email"
        value="{{ email_config.forwarding_email|default:'' }}"
        placeholder="ejemplo@gmail.com"
        style="width: 300px; padding: 0.5rem; border: 3px solid #0f172a; font-family: inherit;"
      >
      <button type="submit">Actualizar</button>

      {% if email_config.forwarding_email %}
      <button type="button" onclick="document.getElementById('forwarding_email').value=''; this.form.submit();" style="background: #666;">
        Borrar
      </button>
      {% endif %}
    </form>

    {% if email_config.forwarding_email %}
    <p style="margin-top: 0.5rem;"><small>üìß Email configurado: <strong>{{ email_config.forwarding_email }}</strong></small></p>
    {% endif %}
  </div>
  {% endif %}

  {% if create_url_name %}
  <p><a href="{% url create_url_name %}?next={{ request.get_full_path|urlencode }}">A√±adir nuevo</a></p>
  {% endif %}
  <ul>
    {% for obj in object_list %}
      <li>
        {{ obj }}
        {% if obj.external_id %}<br><small>ID: {{ obj.external_id }}</small>{% endif %}
        {% if obj.reason %}<br><small>Motivo: {{ obj.reason }}</small>{% endif %}
        {% if obj.payload %}<br><small>Payload: {{ obj.payload }}</small>{% endif %}
        {% if obj.processed_at and obj.processing_error %}
          <br><span style="color: #d9534f; font-weight: bold;">‚ùå Error al procesar: {{ obj.processing_error }}</span>
        {% elif obj.processed_at %}
          <br><small style="color: #5cb85c;">‚úÖ Procesado</small>
        {% elif obj.downloaded_at %}
          <br><small style="color: #f0ad4e;">‚è≥ Pendiente de procesamiento</small>
        {% endif %}
        {% if edit_url_name %} ‚Äî <a href="{% url edit_url_name obj.pk %}?next={{ request.get_full_path|urlencode }}">Editar</a>{% endif %}
        {% if delete_url_name %} ¬∑ <a href="{% url delete_url_name obj.pk %}?next={{ request.get_full_path|urlencode }}">Borrar</a>{% endif %}
      </li>
    {% empty %}
      <li>No hay elementos.</li>
    {% endfor %}
  </ul>
{% endblock %}
