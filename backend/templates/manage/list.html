{% extends 'base.html' %}
{% load expense_filters %}

{% block title %}List ‚Äî Manage{% endblock %}

{% block content %}
  {% if is_onboarding %}
  <div class="onboarding-banner">
    <div class="onboarding-progress">
      <div class="progress-bar">
        <div class="progress-fill" style="width: {{ onboarding_step|multiply:20 }}%;"></div>
      </div>
      <p class="step-text">Paso {{ onboarding_step }} de {{ onboarding_total_steps }}</p>
    </div>
    
    {% if onboarding_step == 1 %}
    <div class="onboarding-message">
      <h2>üéâ ¬°Bienvenido a Cachin!</h2>
      <h3>Paso 1: Tus Primeras Categor√≠as</h3>
      <p>Hemos creado algunas categor√≠as por defecto para que organices tus gastos. Puedes modificarlas o agregar nuevas haciendo clic en "A√±adir nuevo" o "Editar".</p>
      <div class="info-box">
        <strong>üí° Nota importante:</strong> La categor√≠a "Pago de tarjetas" no cuenta en el total mensual para evitar duplicar gastos.
      </div>
      <p class="reminder">üìù Record√° que siempre podr√°s volver a modificar tus categor√≠as m√°s adelante.</p>
      <form method="post" style="margin-top: 1rem;">
        {% csrf_token %}
        <input type="hidden" name="onboarding_confirm" value="1">
        <button type="submit" class="btn-primary">Mis Categor√≠as Est√°n Listas ‚Üí</button>
      </form>
    </div>
    {% elif onboarding_step == 2 %}
    <div class="onboarding-message">
      <h2>üìÅ Paso 2: Proyectos</h2>
      <p>Los proyectos te permiten agrupar gastos incluso cuando est√°n en distintas categor√≠as. Por ejemplo, "Vacaciones de verano" podr√≠a incluir gastos de transporte, comidas, entretenimiento, etc.</p>
      <p>Creamos un proyecto de ejemplo para que veas c√≥mo funciona. Puedes editarlo, eliminarlo o crear nuevos proyectos.</p>
      <p class="reminder">üìù Record√° que siempre podr√°s modificar tus proyectos m√°s adelante.</p>
      <form method="post" style="margin-top: 1rem;">
        {% csrf_token %}
        <input type="hidden" name="onboarding_confirm" value="1">
        <button type="submit" class="btn-primary">Ya Configur√© Mis Proyectos ‚Üí</button>
      </form>
    </div>
    {% elif onboarding_step == 4 %}
    <div class="onboarding-message">
      <h2>üìß Paso 4: Configurar Email</h2>
      <p>Pod√©s automatizar la captura de gastos reenviando los correos de tu banco a tu direcci√≥n √∫nica de Cachin.</p>
      {% if email_config %}
      <div class="email-highlight" style="background:rgba(255,255,255,0.2);padding:1.5rem;border-radius:8px;margin:1.5rem 0;border-left:4px solid white;">
        <p style="margin:0 0 0.5rem 0;font-size:0.9rem;opacity:0.9;"><strong>Tu direcci√≥n para reenviar correos:</strong></p>
        <p style="margin:0;font-size:1.3rem;font-family:monospace;word-break:break-all;background:rgba(0,0,0,0.2);padding:0.75rem;border-radius:4px;">{{ email_config.full_address }}</p>
      </div>
      
      <form method="post" style="background:rgba(255,255,255,0.15);padding:1.5rem;border-radius:8px;margin:1.5rem 0;">
        {% csrf_token %}
        <label style="display:block;margin-bottom:0.5rem;font-weight:500;">
          üì¨ Tu email personal (desde donde reenviar√°s correos):
        </label>
        <input type="email" name="user_email" value="{{ email_config.user_email }}" 
               placeholder="tu.email@ejemplo.com" 
               style="width:100%;padding:0.75rem;border:none;border-radius:4px;font-size:1rem;box-sizing:border-box;margin-bottom:0.5rem;">
        <p style="margin:0.5rem 0 1rem 0;font-size:0.85rem;opacity:0.9;">
          Este es el email desde el cual reenviar√°s los correos de tu banco. Solo los correos de este email ser√°n procesados.
        </p>
        <button type="submit" style="background:white;color:#667eea;border:none;padding:0.5rem 1rem;border-radius:4px;font-weight:500;cursor:pointer;">
          Guardar Email
        </button>
      </form>
      
      <div class="info-box">
        <strong>¬øC√≥mo funciona?</strong>
        <ol style="margin:0.5rem 0 0 1.2rem;padding:0;line-height:1.8;">
          <li>Cuando recibas un correo de tu banco con un gasto, reenvialo a esta direcci√≥n</li>
          <li>Cachin lo procesar√° autom√°ticamente y extraer√° la informaci√≥n del gasto</li>
          <li>Ver√°s la transacci√≥n aparecer en tu lista de gastos</li>
        </ol>
      </div>
      <p style="margin-top:1rem;font-size:0.9rem;opacity:0.9;">üí° <em>Pod√©s copiar esta direcci√≥n y guardarla en tus contactos para usarla f√°cilmente.</em></p>
      {% else %}
      <p style="background:rgba(255,255,255,0.2);padding:1rem;border-radius:6px;">‚ö†Ô∏è <em>No se encontr√≥ tu configuraci√≥n de email. Contact√° a soporte.</em></p>
      {% endif %}
      <p class="reminder">üìù Esta opci√≥n siempre estar√° disponible en "Mis datos" ‚Üí "Emails".</p>
      <form method="post" style="margin-top: 1rem;">
        {% csrf_token %}
        <input type="hidden" name="onboarding_confirm" value="1">
        <button type="submit" class="btn-primary">Ya Configur√© el Mail / Volver√© M√°s Tarde ‚Üí</button>
      </form>
    </div>
    {% endif %}
  </div>
  {% endif %}
  
  <p><a href="{{ back_url|default:'javascript:history.back()' }}">‚Üê Volver</a></p>
  <h1>{{ model_verbose_name_plural|capfirst }}</h1>
  {% if header_note %}
  <p><em>{{ header_note }}</em></p>
  {% endif %}

  {% if email_config %}
  <div style="margin-top: 1rem; padding: 1rem; border: 2px solid #333; background: #f9f9f9;">
    <h3>Configurar Email de Reenv√≠o</h3>
    <p><small>Si reenv√≠as facturas desde tu email personal, config√∫ralo aqu√≠ para que podamos identificar tus mensajes.</small></p>

    <form method="post" action="{% url 'expenses:update_forwarding_email' %}">
      {% csrf_token %}
      <label for="forwarding_email" style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Tu email personal:</label>
      <input
        type="email"
        id="forwarding_email"
        name="forwarding_email"
        value="{{ email_config.forwarding_email|default:'' }}"
        placeholder="ejemplo@gmail.com"
        style="width: 300px; padding: 0.5rem; border: 3px solid #0f172a; font-family: inherit;"
      >
      <button type="submit">Actualizar</button>

      {% if email_config.forwarding_email %}
      <button type="button" onclick="document.getElementById('forwarding_email').value=''; this.form.submit();" style="background: #666;">
        Borrar
      </button>
      {% endif %}
    </form>

    {% if email_config.forwarding_email %}
    <p style="margin-top: 0.5rem;"><small>üìß Email configurado: <strong>{{ email_config.forwarding_email }}</strong></small></p>
    {% endif %}
  </div>
  {% endif %}

  {% if create_url_name %}
  <p><a href="{% url create_url_name %}?next={{ request.get_full_path|urlencode }}">A√±adir nuevo</a></p>
  {% endif %}
  <ul>
    {% for obj in object_list %}
      <li>
        {{ obj }}
        {% if obj.external_id %}<br><small>ID: {{ obj.external_id }}</small>{% endif %}
        {% if obj.reason %}<br><small>Motivo: {{ obj.reason }}</small>{% endif %}
        {% if obj.payload %}<br><small>Payload: {{ obj.payload }}</small>{% endif %}
        {% if obj.processed_at and obj.processing_error %}
          <br><span style="color: #d9534f; font-weight: bold;">‚ùå Error al procesar: {{ obj.processing_error }}</span>
        {% elif obj.processed_at %}
          <br><small style="color: #5cb85c;">‚úÖ Procesado</small>
        {% elif obj.downloaded_at %}
          <br><small style="color: #f0ad4e;">‚è≥ Pendiente de procesamiento</small>
        {% endif %}
        {% if edit_url_name %} ‚Äî <a href="{% url edit_url_name obj.pk %}?next={{ request.get_full_path|urlencode }}">Editar</a>{% endif %}
        {% if delete_url_name %} ¬∑ <a href="{% url delete_url_name obj.pk %}?next={{ request.get_full_path|urlencode }}">Borrar</a>{% endif %}
      </li>
    {% empty %}
      <li>No hay elementos.</li>
    {% endfor %}
  </ul>
  
  <style>
    .onboarding-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .onboarding-progress {
      margin-bottom: 1.5rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    
    .progress-fill {
      height: 100%;
      background-color: white;
      transition: width 0.3s ease;
    }
    
    .step-text {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .onboarding-message h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.8rem;
    }
    
    .onboarding-message h3 {
      margin: 0 0 1rem 0;
      font-size: 1.3rem;
      font-weight: normal;
      opacity: 0.95;
    }
    
    .onboarding-message p {
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    
    .info-box {
      background-color: rgba(255,255,255,0.2);
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      border-left: 4px solid white;
    }
    
    .reminder {
      background-color: rgba(255,255,255,0.15);
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    
    .btn-primary {
      background-color: white;
      color: #667eea;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
  </style>
{% endblock %}
