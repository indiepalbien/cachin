{% extends 'base.html' %}

{% block title %}Mi perfil â€” App-Finanzas{% endblock %}

{% block content %}

  <!-- Email automation moved to Manage views -->

  <!-- Quick-add compact form -->
  <section id="quick-add" style="margin:1rem 0;padding:0.75rem;border:1px solid var(--accent);background:var(--panel);">
    <style>
      /* Compact grid for quick-add, keeps fields aligned and wraps neatly on mobile */
      #quick-add .qa-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
        gap:0.6rem;
        align-items:center;
      }
      #quick-add input{width:100%;box-sizing:border-box;padding:0.5rem 0.65rem}
      #quick-add input[type=number]{appearance:textfield;-moz-appearance:textfield}
      #quick-add input[type=number]::-webkit-outer-spin-button,
      #quick-add input[type=number]::-webkit-inner-spin-button{margin:0;-webkit-appearance:none}
      #quick-add .qa-grid button{grid-column:1/-1}
      @media(min-width:960px){
        #quick-add .qa-grid{grid-template-columns:repeat(4,1fr)}
      }
    </style>
    <form id="quick-add-form"
          hx-post="{% url 'expenses:quick_transaction' %}"
          hx-target="#qa-msg"
          hx-swap="innerHTML"
          hx-indicator="#qa-submit">
      {% csrf_token %}
      <div class="qa-grid">
        <input name="description" id="qa-description" class="qa-description" placeholder="DescripciÃ³n*" required>
        <input name="amount" id="qa-amount" class="qa-amount" type="number" step="0.01" placeholder="Ej: 123.45" required>
        <input name="date" id="qa-date" type="date" required>
        <input name="currency" id="qa-currency" class="qa-currency" list="qa-currencies" placeholder="EUR* / USD*" maxlength="3" required>
        <datalist id="qa-currencies">
          <option value="USD">
          <option value="EUR">
          <option value="UYU">
          <option value="ARS">
          <option value="BRL">
          <option value="GBP">
          <option value="CLP">
          <option value="MXN">
        </datalist>
        <!-- Category: text input with server-rendered suggestions -->
        <input name="category" id="qa-category" list="qa-categorys" placeholder="CategorÃ­a...">
        <datalist id="qa-categorys">
          {% for name in qa_categories %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Project: text input with server-rendered suggestions -->
        <input name="project" id="qa-project" list="qa-projects" placeholder="Proyecto...">
        <datalist id="qa-projects">
          {% for name in qa_projects %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Payee: text input with server-rendered suggestions -->
        <input name="payee" id="qa-payee" list="qa-payees" placeholder="Beneficiario...">
        <datalist id="qa-payees">
          {% for name in qa_payees %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Source: text input with server-rendered suggestions -->
        <input name="source" id="qa-source" list="qa-sources" placeholder="Origen...">
        <datalist id="qa-sources">
          {% for name in qa_sources %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>
        <button id="qa-submit" type="submit">
          <span class="htmx-indicator">Guardando...</span>
          <span class="normal-text">AÃ±adir</span>
        </button>
      </div>
    </form>
    <div id="qa-msg" aria-live="polite" style="margin-top:0.5rem;min-height:1.5rem"></div>
    <style>
      #qa-submit .htmx-indicator { display: none; }
      #qa-submit.htmx-request .htmx-indicator { display: inline; }
      #qa-submit.htmx-request .normal-text { display: none; }
    </style>
    <script>
      // Set default date on page load
      document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('qa-date');
        if (dateInput && !dateInput.value) {
          dateInput.value = new Date().toISOString().slice(0,10);
        }
      });
      // Reset form and reload page after successful submission
      document.getElementById('quick-add-form').addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful) {
          this.reset();
          document.getElementById('qa-date').value = new Date().toISOString().slice(0,10);
          setTimeout(() => window.location.reload(), 700);
        }
      });
    </script>
    
    <!-- Bulk import link -->
    <div style="margin-top:1rem;padding-top:0.75rem;border-top:1px dashed var(--accent);">
      <a href="{% url 'expenses:bulk_add' %}" 
         style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:var(--accent);color:var(--bg);text-decoration:none;border-radius:4px;font-weight:500;transition:opacity .2s"
         onmouseover="this.style.opacity='0.8'" 
         onmouseout="this.style.opacity='1'">
        ðŸ“‹ Importar mÃºltiples transacciones
      </a>
      <span style="margin-left:0.5rem;color:var(--muted);font-size:0.9rem">
        Copiar y pegar desde tu banco
      </span>
    </div>
  </section>


  <!-- Ãšltimas transacciones (paginadas, 5 por pÃ¡gina) -->
  <section id="recent-transactions" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Ãšltimas transacciones</h2>
    {% if tx_page and tx_page.object_list %}
      <ul style="list-style:none;padding:0;margin:0">
        {% for t in tx_page %}
          <li style="display:flex;gap:.5rem;align-items:center;border-bottom:1px dashed var(--accent);padding:.4rem 0">
            <a href="{% url 'expenses:manage_transaction_edit' t.pk %}?next={{ request.get_full_path|urlencode }}"
              title="Editar"
              aria-label="Editar transacciÃ³n"
              style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;color:var(--muted);text-decoration:none;font-size:14px;line-height:1">ðŸ”§</a>
            <span style="flex:2;min-width:160px">{{ t.description }}</span>
            <span style="width:120px;text-align:right">{{ t.amount }}</span>
            <span style="width:70px;text-transform:uppercase;text-align:center">{{ t.currency }}</span>
            <span style="width:130px;text-align:right">{{ t.date }}</span>
          </li>
        {% endfor %}
      </ul>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.5rem">
        <div>
          {% if tx_page.has_previous %}
            <a href="?page={{ tx_page.previous_page_number }}">Â« Anterior</a>
          {% endif %}
        </div>
        <div>
          {% if tx_page.has_next %}
            <a href="?page={{ tx_page.next_page_number }}">Siguiente Â»</a>
          {% endif %}
        </div>
      </div>
      <div style="text-align:center;margin-top:.25rem">
        {% if tx_page.paginator.num_pages <= 7 %}
          {# Show all pages if 7 or fewer #}
          {% for num in tx_page.paginator.page_range %}
            {% if num == tx_page.number %}
              <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
            {% endif %}
          {% endfor %}
        {% else %}
          {# Smart pagination for many pages #}
          {% if tx_page.number <= 4 %}
            {# Near start: 1 2 3 4 5 ... last #}
            {% for num in tx_page.paginator.page_range %}
              {% if num <= 5 or num == tx_page.paginator.num_pages %}
                {% if num == tx_page.number %}
                  <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
                {% else %}
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                {% endif %}
                {% if num == 5 and tx_page.paginator.num_pages > 6 %}
                  <span style="padding:0 .25rem">...</span>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% elif tx_page.number >= tx_page.paginator.num_pages|add:"-3" %}
            {# Near end: 1 ... 22 23 24 25 26 #}
            {% for num in tx_page.paginator.page_range %}
              {% if num == 1 or num >= tx_page.paginator.num_pages|add:"-4" %}
                {% if num == 1 %}
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  {% if tx_page.paginator.num_pages > 6 %}
                    <span style="padding:0 .25rem">...</span>
                  {% endif %}
                {% else %}
                  {% if num == tx_page.number %}
                    <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
                  {% else %}
                    <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% else %}
            {# In middle: 1 ... 10 11 12 ... 26 #}
            {% for num in tx_page.paginator.page_range %}
              {% if num == 1 or num == tx_page.paginator.num_pages or num >= tx_page.number|add:"-1" and num <= tx_page.number|add:"1" %}
                {% if num == 1 %}
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  <span style="padding:0 .25rem">...</span>
                {% elif num == tx_page.paginator.num_pages %}
                  <span style="padding:0 .25rem">...</span>
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                {% else %}
                  {% if num == tx_page.number %}
                    <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
                  {% else %}
                    <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
    {% else %}
      <p style="margin:0">AÃºn no hay transacciones.</p>
    {% endif %}
  </section>

  <!-- Gastos por categorÃ­a con carga independiente -->
  <section id="category-expenses" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Gastos por categorÃ­a</h2>
    <div hx-get="{% url 'expenses:api_category_expenses' %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="innerHTML">
      <p style="text-align:center;color:#999">Cargando gastos...</p>
    </div>
  </section>

  <!-- Gastos por proyecto (total, sin filtro de mes) -->
  <section id="project-expenses" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Gastos por proyecto (Total)</h2>
    <div hx-get="{% url 'expenses:api_project_expenses' %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="innerHTML">
      <p style="text-align:center;color:#999">Cargando gastos...</p>
    </div>
  </section>

  <!-- Gastos por origen (mensual, con navegaciÃ³n) -->
  <section id="source-expenses" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Gastos por origen</h2>
    <div hx-get="{% url 'expenses:api_source_expenses' %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="innerHTML">
      <p style="text-align:center;color:#999">Cargando gastos...</p>
    </div>
  </section>

{% endblock %}
