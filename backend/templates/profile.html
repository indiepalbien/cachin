{% extends 'base.html' %}

{% block title %}Mi perfil ‚Äî App-Finanzas{% endblock %}

{% block content %}

  <!-- Email automation moved to Manage views -->

  <!-- Quick-add compact form -->
  <section id="quick-add" style="margin:1rem 0;padding:0.75rem;border:1px solid var(--accent);background:var(--panel);">
    <style>
      /* Compact grid for quick-add, keeps fields aligned and wraps neatly on mobile */
      #quick-add .qa-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
        gap:0.6rem;
        align-items:center;
      }
      #quick-add input{width:100%;box-sizing:border-box;padding:0.5rem 0.65rem}
      #quick-add input[type=number]{appearance:textfield;-moz-appearance:textfield}
      #quick-add input[type=number]::-webkit-outer-spin-button,
      #quick-add input[type=number]::-webkit-inner-spin-button{margin:0;-webkit-appearance:none}
      #quick-add .qa-grid button{grid-column:1/-1}
      @media(min-width:960px){
        #quick-add .qa-grid{grid-template-columns:repeat(4,1fr)}
      }
    </style>
    <form id="quick-add-form" action="{% url 'expenses:quick_transaction' %}" method="post">
      {% csrf_token %}
      <div class="qa-grid">
        <input name="description" id="qa-description" class="qa-description" placeholder="Descripci√≥n*" required>
        <input name="amount" id="qa-amount" class="qa-amount" type="number" step="0.01" placeholder="Ej: 123.45" required>
        <input name="date" id="qa-date" type="date" required>
        <input name="currency" id="qa-currency" class="qa-currency" list="qa-currencies" placeholder="EUR* / USD*" maxlength="3" required>
        <datalist id="qa-currencies">
          <option value="USD">
          <option value="EUR">
          <option value="UYU">
          <option value="ARS">
          <option value="BRL">
          <option value="GBP">
          <option value="CLP">
          <option value="MXN">
        </datalist>
        <!-- Category: text input with server-rendered suggestions -->
        <input name="category" id="qa-category" list="qa-categorys" placeholder="Categor√≠a...">
        <datalist id="qa-categorys">
          {% for name in qa_categories %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Project: text input with server-rendered suggestions -->
        <input name="project" id="qa-project" list="qa-projects" placeholder="Proyecto...">
        <datalist id="qa-projects">
          {% for name in qa_projects %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Payee: text input with server-rendered suggestions -->
        <input name="payee" id="qa-payee" list="qa-payees" placeholder="Beneficiario...">
        <datalist id="qa-payees">
          {% for name in qa_payees %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>

        <!-- Source: text input with server-rendered suggestions -->
        <input name="source" id="qa-source" list="qa-sources" placeholder="Origen...">
        <datalist id="qa-sources">
          {% for name in qa_sources %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>
        <button id="qa-submit" type="submit">A√±adir</button>
      </div>
    </form>
    <div id="qa-msg" aria-live="polite" style="margin-top:0.5rem;opacity:0;transition:opacity .2s">&nbsp;</div>
    
    <!-- Bulk import link -->
    <div style="margin-top:1rem;padding-top:0.75rem;border-top:1px dashed var(--accent);">
      <a href="{% url 'expenses:bulk_add' %}" 
         style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:var(--accent);color:var(--bg);text-decoration:none;border-radius:4px;font-weight:500;transition:opacity .2s"
         onmouseover="this.style.opacity='0.8'" 
         onmouseout="this.style.opacity='1'">
        üìã Importar m√∫ltiples transacciones
      </a>
      <span style="margin-left:0.5rem;color:var(--muted);font-size:0.9rem">
        Copiar y pegar desde tu banco
      </span>
    </div>
  </section>


  <!-- √öltimas transacciones (paginadas, 5 por p√°gina) -->
  <section id="recent-transactions" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">√öltimas transacciones</h2>
    {% if tx_page and tx_page.object_list %}
      <ul style="list-style:none;padding:0;margin:0">
        {% for t in tx_page %}
          <li style="display:flex;gap:.5rem;align-items:center;border-bottom:1px dashed var(--accent);padding:.4rem 0">
            <a href="{% url 'expenses:manage_transaction_edit' t.pk %}?next={{ request.get_full_path|urlencode }}"
              title="Editar"
              aria-label="Editar transacci√≥n"
              style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;color:var(--muted);text-decoration:none;font-size:14px;line-height:1">üîß</a>
            <span style="flex:2;min-width:160px">{{ t.description }}</span>
            <span style="width:120px;text-align:right">{{ t.amount }}</span>
            <span style="width:70px;text-transform:uppercase;text-align:center">{{ t.currency }}</span>
            <span style="width:130px;text-align:right">{{ t.date }}</span>
          </li>
        {% endfor %}
      </ul>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.5rem">
        <div>
          {% if tx_page.has_previous %}
            <a href="?page={{ tx_page.previous_page_number }}">¬´ Anterior</a>
          {% endif %}
        </div>
        <div>
          {% if tx_page.has_next %}
            <a href="?page={{ tx_page.next_page_number }}">Siguiente ¬ª</a>
          {% endif %}
        </div>
      </div>
      <div style="text-align:center;margin-top:.25rem">
        {% if tx_page.paginator.num_pages <= 7 %}
          {# Show all pages if 7 or fewer #}
          {% for num in tx_page.paginator.page_range %}
            {% if num == tx_page.number %}
              <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
            {% endif %}
          {% endfor %}
        {% else %}
          {# Smart pagination for many pages #}
          {% if tx_page.number <= 4 %}
            {# Near start: 1 2 3 4 5 ... last #}
            {% for num in tx_page.paginator.page_range %}
              {% if num <= 5 or num == tx_page.paginator.num_pages %}
                {% if num == tx_page.number %}
                  <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
                {% else %}
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                {% endif %}
                {% if num == 5 and tx_page.paginator.num_pages > 6 %}
                  <span style="padding:0 .25rem">...</span>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% elif tx_page.number >= tx_page.paginator.num_pages|add:"-3" %}
            {# Near end: 1 ... 22 23 24 25 26 #}
            {% for num in tx_page.paginator.page_range %}
              {% if num == 1 or num >= tx_page.paginator.num_pages|add:"-4" %}
                {% if num == 1 %}
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  {% if tx_page.paginator.num_pages > 6 %}
                    <span style="padding:0 .25rem">...</span>
                  {% endif %}
                {% else %}
                  {% if num == tx_page.number %}
                    <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
                  {% else %}
                    <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% else %}
            {# In middle: 1 ... 10 11 12 ... 26 #}
            {% for num in tx_page.paginator.page_range %}
              {% if num == 1 or num == tx_page.paginator.num_pages or num >= tx_page.number|add:"-1" and num <= tx_page.number|add:"1" %}
                {% if num == 1 %}
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  <span style="padding:0 .25rem">...</span>
                {% elif num == tx_page.paginator.num_pages %}
                  <span style="padding:0 .25rem">...</span>
                  <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                {% else %}
                  {% if num == tx_page.number %}
                    <span style="font-weight:700;border-bottom:2px solid var(--accent);padding:0 .25rem">{{ num }}</span>
                  {% else %}
                    <a href="?page={{ num }}" style="padding:0 .25rem">{{ num }}</a>
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
    {% else %}
      <p style="margin:0">A√∫n no hay transacciones.</p>
    {% endif %}
  </section>

  <!-- Gastos por categor√≠a con carga independiente -->
  <section id="category-expenses" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin:0 0 .5rem 0">
      <h2 style="margin:0">Gastos por categor√≠a</h2>
      <label style="font-size:0.9rem;cursor:pointer;display:flex;align-items:center;gap:0.35rem">
        <input type="checkbox" id="convert-to-usd" style="cursor:pointer">
        <span>Convertir a USD</span>
      </label>
    </div>
    <div id="cat-month-nav" style="text-align:center;margin:.25rem 0 .5rem 0">
      <a href="#" data-action="prev">¬´ Mes anterior</a>
      <span id="cat-month-label" style="margin:0 .75rem">Cargando...</span>
      <a href="#" data-action="current" style="display:none">Mes actual ¬ª</a>
    </div>
    <div id="cat-expenses-content">
      <p style="text-align:center;color:#999">Cargando gastos...</p>
    </div>
  </section>

  <!-- Gastos por proyecto (total, sin filtro de mes) -->
  <section id="project-expenses" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Gastos por proyecto (Total)</h2>
    <div id="proj-expenses-content">
      <p style="text-align:center;color:#999">Cargando gastos...</p>
    </div>
  </section>

  <!-- Gastos por origen (mensual, con navegaci√≥n) -->
  <section id="source-expenses" style="margin:1rem 0;padding:0.5rem;border:1px solid var(--accent);background:var(--panel);">
    <h2 style="margin:0 0 .5rem 0">Gastos por origen</h2>
    <div id="src-month-nav" style="text-align:center;margin:.25rem 0 .5rem 0">
      <a href="#" data-action="prev">¬´ Mes anterior</a>
      <span id="src-month-label" style="margin:0 .75rem">Cargando...</span>
      <a href="#" data-action="current" style="display:none">Mes actual ¬ª</a>
    </div>
    <div id="src-expenses-content">
      <p style="text-align:center;color:#999">Cargando gastos...</p>
    </div>
  </section>

  <script>
  (function() {
    let currentMonth = null;
    let currentMonthStr = null;
    const convertCheckbox = document.getElementById('convert-to-usd');

    // CSRF token helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    async function loadCategoryExpenses(month) {
      const content = document.getElementById('cat-expenses-content');
      const label = document.getElementById('cat-month-label');
      const nav = document.getElementById('cat-month-nav');

      // Show loading
      content.innerHTML = '<p style="text-align:center;color:#999">Cargando...</p>';

      try {
        const url = month ? `/expenses/api/category-expenses/?m=${month}` : '/expenses/api/category-expenses/';
        const response = await fetch(url);

        if (!response.ok) throw new Error('Error al cargar');

        const data = await response.json();

        // Update current state
        currentMonth = data.selected_month_str;
        currentMonthStr = data.m_current;

        // Sync checkbox with backend preference (on first load)
        if (convertCheckbox.checked !== data.convert_to_usd) {
          convertCheckbox.checked = data.convert_to_usd;
        }

        // Update month label
        label.textContent = `Mes ${data.selected_month_str}`;

        // Show/hide "current month" link
        const currentLink = nav.querySelector('[data-action="current"]');
        if (data.selected_month_str !== data.m_current) {
          currentLink.style.display = 'inline';
        } else {
          currentLink.style.display = 'none';
        }

        // Show warning if converting to USD and there are missing rates
        let warningHtml = '';
        if (data.convert_to_usd && data.missing_rates > 0) {
          warningHtml = `<div style="background:#fff4e5;border:1px solid #ffb74d;padding:0.5rem;margin-bottom:0.5rem;border-radius:4px;font-size:0.9rem">
            ‚ö†Ô∏è <strong>${data.missing_rates} transacciones</strong> no tienen tasa de cambio y no est√°n incluidas en estos totales.
          </div>`;
        }

        // Render table
        if (data.cat_expenses && data.cat_expenses.length > 0) {
          let html = warningHtml;
          html += '<table style="width:100%;border-collapse:collapse"><thead><tr>';
          html += '<th style="text-align:left;border-bottom:2px solid var(--border);padding:.25rem 0">Categor√≠a</th>';

          // Show currency column only if not converting to USD
          if (!data.convert_to_usd) {
            html += '<th style="text-align:center;border-bottom:2px solid var(--border);padding:.25rem 0">Moneda</th>';
          }

          html += '<th style="text-align:right;border-bottom:2px solid var(--border);padding:.25rem 0">';
          html += data.convert_to_usd ? 'Total (USD)' : 'Total';
          html += '</th>';
          html += '</tr></thead><tbody>';

          data.cat_expenses.forEach(row => {
            html += '<tr>';

            // Build the URL for filtering transactions
            const categoryParam = encodeURIComponent(row.category);
            const currencyParam = data.convert_to_usd ? '' : `&currency=${encodeURIComponent(row.currency)}`;
            const monthParam = `&month=${encodeURIComponent(data.selected_month_str)}`;
            const filterUrl = `/expenses/manage/category-transactions/?category=${categoryParam}${currencyParam}${monthParam}`;

            html += `<td style="padding:.3rem 0;border-bottom:1px dashed var(--border)">`;
            html += `<a href="${filterUrl}" style="color:var(--accent);text-decoration:none;border-bottom:1px dotted var(--accent)">${row.category}</a>`;
            html += `</td>`;

            if (!data.convert_to_usd) {
              html += `<td style="padding:.3rem 0;text-align:center;border-bottom:1px dashed var(--border)">${row.currency}</td>`;
            }

            html += `<td style="padding:.3rem 0;text-align:right;border-bottom:1px dashed var(--border)">`;
            html += data.convert_to_usd ? `$ ${row.total}` : row.total;
            html += '</td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          content.innerHTML = html;
        } else {
          content.innerHTML = warningHtml + '<p style="padding:.3rem 0">Sin gastos en este mes.</p>';
        }
      } catch (error) {
        console.error('Error loading category expenses:', error);
        content.innerHTML = '<p style="color:#d00">Error al cargar gastos. Refresca la p√°gina.</p>';
      }
    }

    // Handle checkbox change
    convertCheckbox.addEventListener('change', async () => {
      // Save preference to backend
      try {
        const formData = new FormData();
        formData.append('key', 'convert_expenses_to_usd');
        formData.append('value', convertCheckbox.checked ? 'true' : 'false');

        const response = await fetch('/expenses/api/update-preference/', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': csrftoken
          }
        });

        if (response.ok) {
          // Reload with current month
          loadCategoryExpenses(currentMonth);
        } else {
          console.error('Failed to save preference');
          // Revert checkbox on error
          convertCheckbox.checked = !convertCheckbox.checked;
        }
      } catch (error) {
        console.error('Error saving preference:', error);
        // Revert checkbox on error
        convertCheckbox.checked = !convertCheckbox.checked;
      }
    });

    // Handle navigation clicks
    document.getElementById('cat-month-nav').addEventListener('click', (e) => {
      if (e.target.tagName === 'A') {
        e.preventDefault();
        const action = e.target.getAttribute('data-action');

        if (action === 'prev') {
          // Calculate previous month
          const [y, m] = currentMonth.split('-').map(Number);
          const prevY = m === 1 ? y - 1 : y;
          const prevM = m === 1 ? 12 : m - 1;
          const prevMonth = `${prevY.toString().padStart(4, '0')}-${prevM.toString().padStart(2, '0')}`;
          loadCategoryExpenses(prevMonth);
        } else if (action === 'current') {
          loadCategoryExpenses(currentMonthStr);
        }
      }
    });

    // Initial load
    loadCategoryExpenses();
  })();
  </script>

  <script>
  // Project expenses (all time, no month filter)
  (async function() {
    const content = document.getElementById('proj-expenses-content');
    const convertCheckbox = document.getElementById('convert-to-usd');

    async function loadProjectExpenses() {
      try {
        const convertParam = convertCheckbox.checked ? 'true' : 'false';
        const response = await fetch(`/expenses/api/project-expenses/?convert_usd=${convertParam}`);
        const data = await response.json();

        // Build warning message if missing rates
        let warningHtml = '';
        if (data.convert_to_usd && data.missing_rates > 0) {
          warningHtml = `<div style="background:#fff4e5;border:1px solid #ffb74d;padding:0.5rem;margin-bottom:0.5rem;border-radius:4px;font-size:0.9rem">
            ‚ö†Ô∏è <strong>${data.missing_rates} transacciones</strong> no tienen tasa de cambio y no est√°n incluidas.
          </div>`;
        }

        // Render table
        if (data.proj_expenses && data.proj_expenses.length > 0) {
          let html = warningHtml;
          html += '<table style="width:100%;border-collapse:collapse"><thead><tr>';
          html += '<th style="text-align:left;border-bottom:2px solid var(--border);padding:.25rem 0">Proyecto</th>';

          if (!data.convert_to_usd) {
            html += '<th style="text-align:center;border-bottom:2px solid var(--border);padding:.25rem 0">Moneda</th>';
          }

          html += '<th style="text-align:right;border-bottom:2px solid var(--border);padding:.25rem 0">';
          html += data.convert_to_usd ? 'Total (USD)' : 'Total';
          html += '</th></tr></thead><tbody>';

          data.proj_expenses.forEach(row => {
            html += '<tr><td style="padding:.3rem 0;border-bottom:1px dashed var(--border)">' + row.project + '</td>';

            if (!data.convert_to_usd) {
              html += '<td style="padding:.3rem 0;text-align:center;border-bottom:1px dashed var(--border)">' + row.currency + '</td>';
            }

            html += '<td style="padding:.3rem 0;text-align:right;border-bottom:1px dashed var(--border)">';
            html += data.convert_to_usd ? '$ ' + row.total : row.total;
            html += '</td></tr>';
          });

          html += '</tbody></table>';
          content.innerHTML = html;
        } else {
          content.innerHTML = warningHtml + '<p style="padding:.3rem 0">Sin gastos registrados.</p>';
        }
      } catch (error) {
        console.error('Error loading project expenses:', error);
        content.innerHTML = '<p style="color:#d00">Error al cargar gastos. Refresca la p√°gina.</p>';
      }
    }

    // Reload when convert checkbox changes
    convertCheckbox.addEventListener('change', loadProjectExpenses);

    // Initial load
    loadProjectExpenses();
  })();
  </script>

  <script>
  // Source expenses (monthly with navigation)
  (function() {
    let srcCurrentMonth = null;
    let srcCurrentMonthStr = null;
    const convertCheckbox = document.getElementById('convert-to-usd');

    async function loadSourceExpenses(monthParam) {
      const content = document.getElementById('src-expenses-content');
      const monthLabel = document.getElementById('src-month-label');
      const currentLink = document.querySelector('#src-month-nav a[data-action="current"]');

      try {
        const convertParam = convertCheckbox.checked ? 'true' : 'false';
        const url = monthParam
          ? `/expenses/api/source-expenses/?m=${monthParam}&convert_usd=${convertParam}`
          : `/expenses/api/source-expenses/?convert_usd=${convertParam}`;

        const response = await fetch(url);
        const data = await response.json();

        // Update state
        srcCurrentMonth = data.m_prev;
        srcCurrentMonthStr = data.selected_month_str;

        // Update month label
        monthLabel.textContent = data.selected_month_str;

        // Show/hide "Mes actual" link
        if (data.selected_month_str === data.m_current) {
          currentLink.style.display = 'none';
        } else {
          currentLink.style.display = 'inline';
        }

        // Build warning message if missing rates
        let warningHtml = '';
        if (data.convert_to_usd && data.missing_rates > 0) {
          warningHtml = `<div style="background:#fff4e5;border:1px solid #ffb74d;padding:0.5rem;margin-bottom:0.5rem;border-radius:4px;font-size:0.9rem">
            ‚ö†Ô∏è <strong>${data.missing_rates} transacciones</strong> no tienen tasa de cambio y no est√°n incluidas.
          </div>`;
        }

        // Render table
        if (data.src_expenses && data.src_expenses.length > 0) {
          let html = warningHtml;
          html += '<table style="width:100%;border-collapse:collapse"><thead><tr>';
          html += '<th style="text-align:left;border-bottom:2px solid var(--border);padding:.25rem 0">Origen</th>';

          if (!data.convert_to_usd) {
            html += '<th style="text-align:center;border-bottom:2px solid var(--border);padding:.25rem 0">Moneda</th>';
          }

          html += '<th style="text-align:right;border-bottom:2px solid var(--border);padding:.25rem 0">';
          html += data.convert_to_usd ? 'Total (USD)' : 'Total';
          html += '</th></tr></thead><tbody>';

          data.src_expenses.forEach(row => {
            html += '<tr><td style="padding:.3rem 0;border-bottom:1px dashed var(--border)">' + row.source + '</td>';

            if (!data.convert_to_usd) {
              html += '<td style="padding:.3rem 0;text-align:center;border-bottom:1px dashed var(--border)">' + row.currency + '</td>';
            }

            html += '<td style="padding:.3rem 0;text-align:right;border-bottom:1px dashed var(--border)">';
            html += data.convert_to_usd ? '$ ' + row.total : row.total;
            html += '</td></tr>';
          });

          html += '</tbody></table>';
          content.innerHTML = html;
        } else {
          content.innerHTML = warningHtml + '<p style="padding:.3rem 0">Sin gastos en este mes.</p>';
        }
      } catch (error) {
        console.error('Error loading source expenses:', error);
        content.innerHTML = '<p style="color:#d00">Error al cargar gastos. Refresca la p√°gina.</p>';
      }
    }

    // Navigation handlers
    document.querySelector('#src-month-nav a[data-action="prev"]').addEventListener('click', (e) => {
      e.preventDefault();
      loadSourceExpenses(srcCurrentMonth);
    });

    document.querySelector('#src-month-nav a[data-action="current"]').addEventListener('click', (e) => {
      e.preventDefault();
      loadSourceExpenses(null);
    });

    // Reload when convert checkbox changes
    convertCheckbox.addEventListener('change', () => {
      loadSourceExpenses(srcCurrentMonthStr);
    });

    // Initial load
    loadSourceExpenses();
  })();
  </script>

  <script>
  (function(){
    console.log('qa-init')
    // helpers
    function qs(sel){return document.querySelector(sel)}
    function qsa(sel){return document.querySelectorAll(sel)}

    const form = qs('#quick-add-form')
    const msg = qs('#qa-msg')

    // set default date to today
    const dateInput = qs('#qa-date')
    if(dateInput && !dateInput.value){
      const d = new Date();
      dateInput.value = d.toISOString().slice(0,10)
    }

    // Select options are rendered server-side on page load; no client fetch needed.

    // Fallback visual dropdown when browser doesn't show datalist suggestions
    function attachSuggestUI(inputSel, datalistSel){
      const input = qs(inputSel)
      const dl = qs(datalistSel)
      if(!input || !dl) return

      // create container
      const box = document.createElement('div')
      box.style.position = 'absolute'
      // debug-friendly visible styles
      box.style.background = '#ffffff'
      box.style.border = '2px solid #ff2d6d'
      box.style.padding = '4px'
      box.style.display = 'none'
      box.style.zIndex = '2147483647'
      box.style.maxHeight = '220px'
      box.style.overflow = 'auto'
      box.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)'
      box.className = 'qa-suggest-box'
      // append as sibling to input to avoid global click/overlay issues
      const parent = input.parentElement || input.closest('form') || document.body
      // ensure parent is positioned so absolute box is relative to it
      const parentPos = window.getComputedStyle(parent).position
      if(!parentPos || parentPos === 'static') parent.style.position = 'relative'
      parent.insertBefore(box, input.nextSibling)

      function rebuild(){
        box.innerHTML = ''
        const opts = Array.from(dl.querySelectorAll('option')).map(o=>o.value)
        // log for debugging
        console.log('qa-datalist rebuild', inputSel, opts)
        opts.forEach(val=>{
          const it = document.createElement('div')
          it.textContent = val
          it.style.padding = '4px'
          it.style.cursor = 'pointer'
          // use pointerdown to avoid blur-before-click issues and dispatch input event after setting
          it.addEventListener('pointerdown', function(ev){
            input.value = val
            input.dispatchEvent(new Event('input', {bubbles:true}))
            hide()
          })
          box.appendChild(it)
        })
        // If the input is currently focused, show the box so new options are visible immediately
        try{
          if(document.activeElement === input && box.children.length){
            show()
          }
        }catch(e){/* ignore */}
      }

      function show(){
        console.log('qa-show', inputSel)
        const rect = input.getBoundingClientRect()
        // position relative to parent
        const pRect = parent.getBoundingClientRect()
        box.style.left = (rect.left - pRect.left) + 'px'
        box.style.top = (rect.bottom - pRect.top) + 'px'
        box.style.width = rect.width + 'px'
        rebuild()
        box.style.display = 'block'
      }
      function hide(){ console.log('qa-hide', inputSel); box.style.display = 'none' }

      input.addEventListener('focus', ()=>{
        // if there are options, show box
        if(dl.querySelectorAll('option').length) show()
      })
      input.addEventListener('input', ()=>{
        const q = input.value.toLowerCase()
        Array.from(box.children).forEach(child=>{
          child.style.display = child.textContent.toLowerCase().includes(q) ? 'block' : 'none'
        })
        if(box.children.length && box.style.display!=='block') show()
      })
      // hide when input loses focus (delay to allow pointerdown selection)
      input.addEventListener('focusout', ()=>{
        setTimeout(()=>{
          if(document.activeElement !== input && !box.contains(document.activeElement)) hide()
        }, 120)
      })
      // rebuild when datalist updates
      const obs = new MutationObserver(rebuild)
      obs.observe(dl, {childList:true})
      console.log('qa-attachSuggestUI', inputSel, datalistSel)
    }

    // attach suggest UI to inputs
    // old datalist-based fallback is no longer used; still keep attachSuggestUI safe
    // attachSuggestUI('#qa-category','#qa-categories')
    // attachSuggestUI('#qa-project','#qa-projects')
    // attachSuggestUI('#qa-payee','#qa-payees')
    // attachSuggestUI('#qa-source','#qa-sources')

    // Debug helper: show datalist options and input values
    function updateDebug(){
      try{
        const parts = []
        ;['category','project','payee','source'].forEach(name=>{
          const inp = qs('#qa-'+name)
          const dl = qs('#qa-'+name+'s')
          if(!inp) return
          const opts = dl ? Array.from(dl.options).map(o=>({v:o.value,t:o.value})) : []
          parts.push(name.toUpperCase()+": options:"+opts.length+" value:"+(inp.value||''))
          parts.push(JSON.stringify(opts))
        })
        const debugEl = qs('#qa-debug')
        if(!debugEl){
          // No debug container present; skip safely
          return
        }
        debugEl.textContent = parts.join('\n')
      }catch(e){ console.log('qa-debug err', e) }
    }

    // wire up text inputs to update debug on change
    ;['category','project','payee','source'].forEach(name=>{
      const inp = qs('#qa-'+name)
      if(!inp) return
      inp.addEventListener('input', updateDebug)
      inp.addEventListener('change', updateDebug)
    })

    // submit handler (AJAX) ‚Äî uses fetch and expects JSON
    form.addEventListener('submit', async function(ev){
      try{
        if(!form) return
        if(ev && typeof ev.preventDefault === 'function'){
          ev.preventDefault()
        } else if (window.event && typeof window.event.preventDefault === 'function'){
          window.event.preventDefault()
        }

        const fd = new FormData(form)
        // client-side amount validation/normalization
        const amtRaw = (fd.get('amount')||'').toString().replace(',','.')
        const amtNum = Number(amtRaw)
        if(!Number.isFinite(amtNum)){
          showMsg('Importe inv√°lido. Ej: 123.45', true)
          return
        }
        fd.set('amount', amtNum.toFixed(2))
        // client-side currency normalization
        const cur = (fd.get('currency')||'').toUpperCase().trim()
        if(!/^[A-Z]{3}$/.test(cur)){
          showMsg('Moneda inv√°lida (3 letras).', true)
          return
        }
        fd.set('currency', cur)

      try{
        const res = await fetch(form.action, {method:'POST', body:fd, credentials: 'same-origin', headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}})
        const contentType = res.headers.get('content-type') || ''
        let json = null
        if(contentType.includes('application/json')){
          json = await res.json()
        } else {
          showMsg('Respuesta inesperada del servidor.', true)
          return
        }
        if(res.ok && json.success){
          // Show success briefly, then refresh so new data appears
          showMsg(json.message || 'A√±adido', false)
          setTimeout(()=>{ window.location.reload() }, 700)
        }else{
          const errs = (json && (json.errors || (json.message && [json.message]))) || ['Error']
          showMsg(errs.join(' / '), true)
        }
      }catch(err){
        console.error('quick-add submit error', err)
        showMsg('Error enviando. Intent√° de nuevo.', true)
      }
      }catch(err){
        console.error('quick-add handler error', err)
        showMsg('Error procesando formulario.', true)
      }
    })

    // initial debug update so panel shows server-rendered values
    updateDebug()

    function showMsg(text, isError){
      msg.textContent = text
      msg.style.opacity = '1'
      msg.style.color = isError ? '#dc2626' : 'var(--accent)'
      setTimeout(()=>{ msg.style.opacity = '0' }, 1000)
    }
  })()
  </script>
{% endblock %}
