{% extends 'base.html' %}

{% block title %}Mi perfil â€” App-Finanzas{% endblock %}

{% block content %}

  {% if is_onboarding and onboarding_step == 5 %}
  <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6 md:p-8 rounded-lg mb-6 shadow-lg">
    <div class="mb-6">
      <div class="w-full h-2 bg-white/30 rounded overflow-hidden mb-2">
        <div class="h-full bg-white transition-all duration-300" style="width: 100%;"></div>
      </div>
      <p class="m-0 text-sm opacity-90">Paso 5 de 5 - Â¡Ãšltimo paso!</p>
    </div>

    <div>
      <h2 class="m-0 mb-2 text-2xl md:text-3xl font-extrabold">ğŸ‰ Â¡Ya casi terminamos!</h2>
      <h3 class="m-0 mb-4 text-lg md:text-xl font-normal opacity-95">Paso 5: Tu Panel de Control</h3>
      <p class="leading-relaxed mb-4">Este es tu panel principal donde podrÃ¡s ver tus transacciones recientes, agregar gastos rÃ¡pidamente y ver resÃºmenes por categorÃ­a, proyecto y origen.</p>
      <div class="bg-white/20 p-4 rounded-md my-4 border-l-4 border-white">
        <strong class="block mb-2">ğŸ’¡ Funciones principales:</strong>
        <ul class="my-2 ml-5 p-0 leading-loose">
          <li><strong>AÃ±adir transacciones:</strong> Usa el formulario rÃ¡pido para registrar gastos</li>
          <li><strong>Ver resÃºmenes:</strong> Analiza tus gastos por categorÃ­a, proyecto u origen</li>
          <li><strong>Gestionar datos:</strong> Accede a "Mis datos" para configurar todo</li>
        </ul>
      </div>
      <p class="bg-white/15 p-3 rounded my-4">ğŸ“ Â¡EstÃ¡s listo para empezar a usar Cachin! Presiona el botÃ³n para completar la configuraciÃ³n.</p>
      <form method="post" class="mt-4">
        {% csrf_token %}
        <input type="hidden" name="onboarding_complete" value="1">
        <button type="submit" class="bg-white text-indigo-600 px-6 py-3 border-0 text-base font-bold rounded-md cursor-pointer transition-all hover:-translate-y-1 hover:shadow-lg min-h-[44px]">Â¡Comenzar a Usar Cachin! ğŸš€</button>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Gastos por categorÃ­a con carga independiente -->
  <section id="category-expenses" class="my-4 p-3 md:p-4 border border-accent bg-panel rounded">
    <h2 class="mt-0 mb-3 text-lg md:text-xl font-extrabold">Gastos por categorÃ­a</h2>
    <div id="category-expenses-section"
         hx-get="{% url 'expenses:api_category_expenses' %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="outerHTML">
      <p class="text-center text-slate-500">Cargando gastos...</p>
    </div>
  </section>

  <!-- Ãšltimas transacciones (paginadas, 5 por pÃ¡gina) -->
  <section id="recent-transactions" class="my-4 p-3 md:p-4 border border-accent bg-panel rounded">
    <h2 class="mt-0 mb-3 text-lg md:text-xl font-extrabold">Ãšltimas transacciones</h2>
    {% if tx_page and tx_page.object_list %}
      <ul class="list-none p-0 m-0 space-y-2 md:space-y-0">
        {% for t in tx_page %}
          <li class="flex flex-wrap md:flex-nowrap gap-2 md:gap-3 items-center border-b border-dashed border-accent p-3 md:p-2 bg-white md:bg-transparent rounded md:rounded-none relative">
            <a href="{% url 'expenses:manage_transaction_edit' t.pk %}?next={{ request.get_full_path|urlencode }}"
              title="Editar"
              aria-label="Editar transacciÃ³n"
              class="absolute md:relative top-2 right-2 md:top-auto md:right-auto flex items-center justify-center w-8 h-8 md:w-6 md:h-6 text-muted no-underline text-sm md:text-xs bg-accent md:bg-transparent text-white md:text-muted rounded">ğŸ”§</a>

            <!-- Mobile: Full width description with category -->
            <span class="flex-[0_0_calc(100%-40px)] md:flex-[2] md:min-w-[160px] text-base md:text-sm text-muted break-words">
              <span class="font-semibold md:font-normal">{{ t.description }}</span>
              {% if t.category %}
                <span class="block md:inline text-xs text-slate-500 mt-1 md:mt-0 md:ml-2">{{ t.category.name }}</span>
              {% endif %}
            </span>

            <!-- Mobile: Amount, currency, date on one row -->
            <span class="flex-[0_0_auto] font-bold md:font-normal text-base md:text-sm text-accent md:text-muted md:w-[120px] md:text-right">{{ t.amount }}</span>
            <span class="flex-[0_0_auto] text-sm md:text-xs text-muted uppercase md:w-[70px] md:text-center">{{ t.currency }}</span>
            <span class="flex-[0_0_100%] md:flex-initial text-sm md:text-xs text-slate-600 md:w-[130px] md:text-right">{{ t.date }}</span>
          </li>
        {% endfor %}
      </ul>

      <div class="flex flex-wrap justify-between items-center gap-2 mt-3">
        <div>
          {% if tx_page.has_previous %}
            <a href="?page={{ tx_page.previous_page_number }}" class="text-accent font-bold hover:underline min-h-[44px] inline-flex items-center">Â« Anterior</a>
          {% endif %}
        </div>
        <div>
          {% if tx_page.has_next %}
            <a href="?page={{ tx_page.next_page_number }}" class="text-accent font-bold hover:underline min-h-[44px] inline-flex items-center">Siguiente Â»</a>
          {% endif %}
        </div>
      </div>

      <div class="text-center mt-2">
        {% if tx_page.paginator.num_pages <= 7 %}
          {# Show all pages if 7 or fewer #}
          {% for num in tx_page.paginator.page_range %}
            {% if num == tx_page.number %}
              <span class="font-bold border-b-2 border-accent px-1 inline-block min-h-[44px]">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" class="px-1 hover:underline inline-block min-h-[44px]">{{ num }}</a>
            {% endif %}
          {% endfor %}
        {% else %}
          {# Smart pagination for many pages #}
          {% if tx_page.number <= 4 %}
            {# Near start: 1 2 3 4 5 ... last #}
            {% for num in tx_page.paginator.page_range %}
              {% if num <= 5 or num == tx_page.paginator.num_pages %}
                {% if num == tx_page.number %}
                  <span class="font-bold border-b-2 border-accent px-1">{{ num }}</span>
                {% else %}
                  <a href="?page={{ num }}" class="px-1 hover:underline">{{ num }}</a>
                {% endif %}
                {% if num == 5 and tx_page.paginator.num_pages > 6 %}
                  <span class="px-1">...</span>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% elif tx_page.number >= tx_page.paginator.num_pages|add:"-3" %}
            {# Near end: 1 ... 22 23 24 25 26 #}
            {% for num in tx_page.paginator.page_range %}
              {% if num == 1 or num >= tx_page.paginator.num_pages|add:"-4" %}
                {% if num == 1 %}
                  <a href="?page={{ num }}" class="px-1 hover:underline">{{ num }}</a>
                  {% if tx_page.paginator.num_pages > 6 %}
                    <span class="px-1">...</span>
                  {% endif %}
                {% else %}
                  {% if num == tx_page.number %}
                    <span class="font-bold border-b-2 border-accent px-1">{{ num }}</span>
                  {% else %}
                    <a href="?page={{ num }}" class="px-1 hover:underline">{{ num }}</a>
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% else %}
            {# In middle: 1 ... 10 11 12 ... 26 #}
            {% for num in tx_page.paginator.page_range %}
              {% if num == 1 or num == tx_page.paginator.num_pages or num >= tx_page.number|add:"-1" and num <= tx_page.number|add:"1" %}
                {% if num == 1 %}
                  <a href="?page={{ num }}" class="px-1 hover:underline">{{ num }}</a>
                  <span class="px-1">...</span>
                {% elif num == tx_page.paginator.num_pages %}
                  <span class="px-1">...</span>
                  <a href="?page={{ num }}" class="px-1 hover:underline">{{ num }}</a>
                {% else %}
                  {% if num == tx_page.number %}
                    <span class="font-bold border-b-2 border-accent px-1">{{ num }}</span>
                  {% else %}
                    <a href="?page={{ num }}" class="px-1 hover:underline">{{ num }}</a>
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      </div>
    {% else %}
      <p class="m-0">AÃºn no hay transacciones.</p>
    {% endif %}
  </section>

  <!-- Gastos por proyecto (total, sin filtro de mes) -->
  <section id="project-expenses" class="my-4 p-3 md:p-4 border border-accent bg-panel rounded">
    <h2 class="mt-0 mb-3 text-lg md:text-xl font-extrabold">Gastos por proyecto (Total)</h2>
    <div id="project-expenses-section"
         hx-get="{% url 'expenses:api_project_expenses' %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="outerHTML">
      <p class="text-center text-slate-500">Cargando gastos...</p>
    </div>
  </section>

  <!-- Gastos por origen (mensual, con navegaciÃ³n) -->
  <section id="source-expenses" class="my-4 p-3 md:p-4 border border-accent bg-panel rounded">
    <h2 class="mt-0 mb-3 text-lg md:text-xl font-extrabold">Gastos por origen</h2>
    <div id="source-expenses-section"
         hx-get="{% url 'expenses:api_source_expenses' %}"
         hx-trigger="load"
         hx-target="this"
         hx-swap="outerHTML">
      <p class="text-center text-slate-500">Cargando gastos...</p>
    </div>
  </section>

{% endblock %}
